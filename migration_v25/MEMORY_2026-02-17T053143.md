# ERTE Project Memory

## Key Architecture
- Main JS file: `enhanced-rich-text-editor-demo/src/main/frontend/src/tab-stop-prototype.js`
- Quill.js v1.3.6 based, Polymer web component
- Tab system: custom blots (TabBlot, SoftBreakBlot) with iterative width calculation
- Delta format: Quill Delta JSON

## V25 Migration Analysis (v25 branch)
- **Documents in `migration_v25/`**: `agents_analysis.md`, `implementation_notes.md`, `feature_comparison.md`, `quill_v1_to_v2_api_diff.md`, `user_description.md`, `agents_analysis_ANSWERED.md`
- **RTE 2 (Vaadin 25.0.4)**: Lit-based, Quill **2.0.3** (vendored), tag `<vaadin-rich-text-editor>`, NO toolbar slots, open shadow DOM, `_editor` exposes Quill instance
- **17 of 20 features** need CUSTOM migration; 3 are free from RTE 2
- **4 HIGH-impact Quill v2 changes**: keyboard bindings (numeric→string keys), history stack, embed guard nodes, blot constructor signature
- **5 Parchment 3 breaking changes** (from Table Spike): `Parchment.create()`→`scroll.create()`, `replace()`→`replaceWith()` (reversed semantics), `defaultChild` must be class ref not string, `checkMerge()` must be overridden, merge loops needed in optimize()
- **Decided**:
  1. Value format: **HTML-primary + `asDelta()` wrapper** (RTE 2 default)
  2. Java API: **Clean break** -- neue API, kein deprecated Ballast
  3. Tag name: **`vcf-enhanced-rich-text-editor`** (eigener Tag)
  4. Table extension: **Rewrite blots for Quill 2** -- forked from `quill1-table` (dclement8←acatec←dost), no Quill 2 port exists, delta format preserved, Java code (~3500 LOC) untouched
  5. Delta migration: **Keine Konvertierung nötig** -- Blot-Namen/Attribute bleiben gleich, nur Quill 2 API intern
  6. JS architecture: extend RTE 2 JS class (`render()` override für Toolbar, `ready()` für Quill hooks)
  7. Java package: `com.vaadin.flow.component.richtexteditor` (access to package-private methods)
- **Spike**: 23 items in `implementation_notes.md` section 10. Spike project at `migration_v25/spike/`. Results in `spike/SPIKE_RESULTS.md`.
  - Phase 1 (**DONE**): Items 2,3,4,8,9,10,13,15,17,20,22 -- ALL PASS. Core architecture VIABLE.
  - Phase 2 (**DONE**): Items 5,6,7,14 -- ALL PASS. Keyboard, bindings, lifecycle validated.
  - Phase 3 (**DONE**): Items 11,12,16,19,21,23 -- ALL PASS. Critical: sanitizer strips `class`. Lumo/Aura via `@StyleSheet` (V25 breaking change: not auto-loaded). ERTE 1 custom styles (Polymer `<custom-style>`, `registerStyles()`) müssen auf Lit `static get styles()` oder `::part()` migriert werden.
  - Phase 4 (**DONE**): Visual verification via Playwright MCP -- ALL PASS. 0 errors, 0 warnings. Lumo theming, ReadOnly toggle, ::part() styling, Delta tabs, Tab key binding, WS button all verified visually. Screenshots in `spike/screenshots/`.
  - Phase 5 (Table Spike, **DONE**): Table blot migration to Quill 2/Parchment 3 -- 7/7 PASS. 2x2 and 3x3 tables work. 5 Parchment 3 breaking changes found and fixed.
- **Spike Phase 1 Key Findings**:
  - Vaadin 25 requires `vaadin` (not `vaadin-core`) -- RTE is now Pro component
  - Vaadin 25 requires **Spring Boot 4.x** (tested 4.0.2)
  - `window.Quill` available globally (v2.0.3), `Quill.register()` works at module top-level
  - `@Tag` on subclass correctly overrides parent tag
  - `render()` override: parent observers (_onReadonlyChanged etc.) still work via `part` selectors
  - `_editor` available immediately after `super.ready()`
  - Guard nodes (`\uFEFF`) are INSIDE embed element, NOT outside -- measure outer `.ql-tab` for width
  - `contentNode` is 0px wide (empty) -- all styling on outer element
  - Delta: embeds = length 1, guard nodes don't leak into deltas
  - `@NpmPackage` inherited from parent -- no annotation needed on subclass
  - Content set in `ready()` gets overwritten by Java value sync -- set content via Java API instead
- Agent error lesson: a24d171 wrongly claimed "RTE 2 uses Quill 1" from web search -- always verify against actual source files

## Server Scripts (Spike Module)
- `migration_v25/spike/server-start.sh` - Port 8081 default, PID `/tmp/claude-spike-server.pid`, log `/tmp/claude-spike-server.log`
- `migration_v25/spike/server-stop.sh` - Stops by PID file or port fallback
- `migration_v25/spike/print-server-logs.sh` - `-f` follow, `-state` status, `-errors` errors

## Server Scripts (Demo Module)
- `server-start.sh` - Starts Spring Boot on port 8080, PID in `/tmp/claude-server.pid`, logs in `/tmp/claude-server.log`
- `server-stop.sh` - Stops server by PID file
- `print-server-logs.sh` - Show logs (`-f` for follow, `-state` for state grep)
- Playwright tests expect port 8080 (configured in `playwright.config.ts`)

## Test Workflow
1. `mvn clean package -DskipTests` (build)
2. `cd enhanced-rich-text-editor-demo && bash server-start.sh` (start server)
3. `cd enhanced-rich-text-editor-demo && npx playwright test` (run 75 tests)
4. `bash server-stop.sh` (stop server)

## Completed Changes

### TabConverter.java (tabstop-rework-2 branch)
- Converts old ERTE tab delta format to new prototype format
- Located in demo module: `com.vaadin.componentfactory.TabConverter`
- 21 JUnit tests in `TabConverterTest.java`
- Uses `elemental.json` (already in project)

### Soft-Break Fix (tabstop-rework-2 branch)
- **Problem 1:** Soft-break inserted at end of visual line instead of cursor position
- **Fix 1:** `tab-stop-prototype.js:185`: `lineStartIndex + offset` instead of `lineStartIndex + visualLineEnd`
- **Problem 2:** After soft-break, typing text at non-last tabstop broke subsequent tab alignment
- **Root cause:** `_isWrappedLine()` only traversed backward through tab siblings; text nodes between soft-break and tabs caused early exit → tabs incorrectly classified as auto-wrap
- **Fix 2:** `_isWrappedLine()` now traverses ALL siblings, using `getBoundingClientRect()` to detect visual line changes. Finds soft-break through text+tab chains. Stops at elements on different visual lines (genuine auto-wrap).
- All 75 Playwright tests pass without modification

## Patterns & Lessons
- `elemental.json` doesn't guarantee key order in serialization - use semantic JSON comparison in tests, not string equality
- Soft-break handler: tabs are counted from `visualLineStart` to `offset` (cursor), then copied after the soft-break insertion point
- Tab counts remain identical whether break is at cursor or end-of-line (content just moves, no tabs added/removed)
- `_isWrappedLine` must handle mixed content (tabs + text) between soft-break and current tab - can't just traverse tab chains
- Use `getBoundingClientRect()` + `threshold` comparison to detect visual line boundaries when traversing siblings
- Server scripts use `./mvnw` wrapper, not system `mvn` - but both work
- Customer screenshots in `/home/node/transfer/erte/`
- **Vaadin MCP Tools nutzen!** `mcp__vaadin__search_vaadin_docs`, `get_component_java_api`, `get_full_document` etc. -- NICHT JARs dekompilieren. GitHub-Repos mit Sources stehen auch zur Verfügung.
- Agent error: Agents decompiled JARs instead of using available MCP tools -- always use MCP first for Vaadin API docs
