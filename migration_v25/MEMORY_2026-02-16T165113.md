# ERTE Project Memory

## Key Architecture
- Main JS file: `enhanced-rich-text-editor-demo/src/main/frontend/src/tab-stop-prototype.js`
- Quill.js v1.3.6 based, Polymer web component
- Tab system: custom blots (TabBlot, SoftBreakBlot) with iterative width calculation
- Delta format: Quill Delta JSON

## V25 Migration Analysis (v25 branch)
- **Documents in `migration_v25/`**: `agents_analysis.md`, `implementation_notes.md`, `feature_comparison.md`, `quill_v1_to_v2_api_diff.md`, `user_description.md`, `agents_analysis_ANSWERED.md`
- **RTE 2 (Vaadin 25.0.4)**: Lit-based, Quill **2.0.3** (vendored), tag `<vaadin-rich-text-editor>`, NO toolbar slots, open shadow DOM, `_editor` exposes Quill instance
- **17 of 20 features** need CUSTOM migration; 3 are free from RTE 2
- **4 HIGH-impact Quill v2 changes**: keyboard bindings (numeric→string keys), history stack, embed guard nodes, blot constructor signature
- **Decided**:
  1. Value format: **HTML-primary + `asDelta()` wrapper** (RTE 2 default)
  2. Java API: **Clean break** -- neue API, kein deprecated Ballast
  3. Tag name: **`vcf-enhanced-rich-text-editor`** (eigener Tag)
  4. Table extension: **Rewrite blots for Quill 2** -- forked from `quill1-table` (dclement8←acatec←dost), no Quill 2 port exists, delta format preserved, Java code (~3500 LOC) untouched
  5. Delta migration: **Keine Konvertierung nötig** -- Blot-Namen/Attribute bleiben gleich, nur Quill 2 API intern
  6. JS architecture: extend RTE 2 JS class (`render()` override für Toolbar, `ready()` für Quill hooks)
  7. Java package: `com.vaadin.flow.component.richtexteditor` (access to package-private methods)
- **Spike**: 23 items in `implementation_notes.md` section 10. Phase 1 running (fullstack-developer agent `a03aa50`). Spike project at `migration_v25/spike/`.
  - Phase 1 (in_progress): Items 2,3,4,8,9,10,13,20 -- project scaffolding + viability
  - Phase 2 (pending): Items 5,6,7,14,15,22 -- architecture validation
  - Phase 3 (pending): Items 11,12,16,17,19,21,23 -- theme, build, data integrity
  - Phase 4 (pending): ui-explorer visual verification
  - Phase 5 (pending): docs-engineer consolidation + housekeeper cleanup
- Agent error lesson: a24d171 wrongly claimed "RTE 2 uses Quill 1" from web search -- always verify against actual source files

## Server Scripts (Demo Module)
- `server-start.sh` - Starts Spring Boot on port 8080, PID in `/tmp/claude-server.pid`, logs in `/tmp/claude-server.log`
- `server-stop.sh` - Stops server by PID file
- `print-server-logs.sh` - Show logs (`-f` for follow, `-state` for state grep)
- Playwright tests expect port 8080 (configured in `playwright.config.ts`)

## Test Workflow
1. `mvn clean package -DskipTests` (build)
2. `cd enhanced-rich-text-editor-demo && bash server-start.sh` (start server)
3. `cd enhanced-rich-text-editor-demo && npx playwright test` (run 75 tests)
4. `bash server-stop.sh` (stop server)

## Completed Changes

### TabConverter.java (tabstop-rework-2 branch)
- Converts old ERTE tab delta format to new prototype format
- Located in demo module: `com.vaadin.componentfactory.TabConverter`
- 21 JUnit tests in `TabConverterTest.java`
- Uses `elemental.json` (already in project)

### Soft-Break Fix (tabstop-rework-2 branch)
- **Problem 1:** Soft-break inserted at end of visual line instead of cursor position
- **Fix 1:** `tab-stop-prototype.js:185`: `lineStartIndex + offset` instead of `lineStartIndex + visualLineEnd`
- **Problem 2:** After soft-break, typing text at non-last tabstop broke subsequent tab alignment
- **Root cause:** `_isWrappedLine()` only traversed backward through tab siblings; text nodes between soft-break and tabs caused early exit → tabs incorrectly classified as auto-wrap
- **Fix 2:** `_isWrappedLine()` now traverses ALL siblings, using `getBoundingClientRect()` to detect visual line changes. Finds soft-break through text+tab chains. Stops at elements on different visual lines (genuine auto-wrap).
- All 75 Playwright tests pass without modification

## Patterns & Lessons
- `elemental.json` doesn't guarantee key order in serialization - use semantic JSON comparison in tests, not string equality
- Soft-break handler: tabs are counted from `visualLineStart` to `offset` (cursor), then copied after the soft-break insertion point
- Tab counts remain identical whether break is at cursor or end-of-line (content just moves, no tabs added/removed)
- `_isWrappedLine` must handle mixed content (tabs + text) between soft-break and current tab - can't just traverse tab chains
- Use `getBoundingClientRect()` + `threshold` comparison to detect visual line boundaries when traversing siblings
- Server scripts use `./mvnw` wrapper, not system `mvn` - but both work
- Customer screenshots in `/home/node/transfer/erte/`
