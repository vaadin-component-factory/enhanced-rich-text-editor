# Phase 5.0: Public API Breaking Changes Audit

**Status:** COMPLETE — Inventory + Assessment done

## Goal

Identify ALL breaking changes between ERTE V24 and V25, assess whether each is
**necessary** or **unnecessary**, and recommend rollbacks for unnecessary ones.

## Categories

- **NECESSARY — Platform** (Vaadin 25 / Jackson 3 force it)
- **NECESSARY — Quill 2** (Quill 2 / Parchment 3 force it)
- **NECESSARY — Architecture** (V25 architecture: extends RichTextEditor, HTML-primary)
- **NECESSARY — Bugfix** (typo fix, security fix, validation)
- **UNNECESSARY — Optimization** (removed as simplification, not required by V25)
- **UNNECESSARY — Oversight** (accidentally not migrated, easy to restore)

---

## Summary

| Category | Count | Action |
|----------|-------|--------|
| NECESSARY — Platform | ~30 | Keep (Jackson 3) |
| NECESSARY — Architecture | ~20 | Keep (RTE 2 base, HTML-primary) |
| NECESSARY — Quill 2 | ~5 | Keep (key names, delta format) |
| NECESSARY — Bugfix | ~12 | Keep (typo fixes, validation) |
| **UNNECESSARY — Optimization** | **~4** | **Rollback recommended** |
| **UNNECESSARY — Oversight** | **~3** | **Rollback recommended** |

### Rollback candidates (7 items)

| # | Change | Effort | Priority |
|---|--------|--------|----------|
| R1 | Restore constructors `ERTE(String)`, `ERTE(ValueChangeListener)`, `ERTE(String, VCL)` | Easy | HIGH |
| R2 | `setPlaceholders(List)` → restore `Collection` parameter | Easy | HIGH |
| R3 | Restore `getPlaceholderAltAppearancePattern()` getter | Easy | HIGH |
| R4 | Restore SlotUtil 2-arg `addComponent(ERTE, Component)` | Easy | MEDIUM |
| R5 | Restore SlotUtil 3-arg `addComponentAtIndex(ERTE, Component, int)` | Easy | MEDIUM |
| R7 | Add `getButtonName()` as deprecated alias on ToolbarButton | Easy | MEDIUM |
| R8 | Restore `TemplateParser.isValidColor(String)` as delegate | Easy | LOW |

~~R10~~ — `Boolean` → `boolean` bei Keyboard-Shortcuts: **Kein Rollback nötig.** `null` hatte keine
eigene Semantik — wird auf JS-Seite via `!!` zu `false`. Primitives sind semantisch korrekt.

~~R11~~ — `EnhancedRichTextEditorVariant`: **Kein Rollback nötig.** Parent `RichTextEditor` bietet
`RichTextEditorVariant.LUMO_COMPACT` und `RichTextEditorVariant.LUMO_NO_BORDER` direkt an.
Nur im Upgrade Guide dokumentieren: `EnhancedRichTextEditorVariant` → `RichTextEditorVariant`.

---

## Full Assessment

### 1. Class Hierarchy

| # | V24 | V25 | Category | Rollback? |
|---|---|---|---|---|
| 1 | `ERTE extends GeneratedERTE<ERTE,String> implements HasSize, HasValueChangeMode, InputNotifier, KeyNotifier, CompositionNotifier` | `ERTE extends RichTextEditor` | NECESSARY — Architecture | No — V25 is built on RTE 2 |

**Why:** V24 used a Polymer-generated base class. V25 uses Vaadin's RTE 2 (Lit-based) as base. The generated class is an artifact of V14-era code generation, not applicable to V25. Interfaces like `HasValueChangeMode` are inherited from `RichTextEditor` where applicable.

### 2. Removed Classes

#### 2.1 GeneratedEnhancedRichTextEditor

| # | V24 Member | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `class GeneratedERTE` itself | REMOVED | NECESSARY — Architecture | No |
| 2 | `addThemeVariants(Variant...)` | Inherited from parent (uses `RichTextEditorVariant`) | NECESSARY — Architecture | No |
| 3 | `removeThemeVariants(Variant...)` | Inherited from parent | NECESSARY — Architecture | No |
| 4 | `setTabStops(List)` | Moved to ERTE | Not breaking | — |
| 5 | `getTabStops()` | Moved to ERTE | Not breaking | — |
| 6 | `getHtmlValueString()` | REMOVED | NECESSARY — Architecture | No — parent provides |
| 7 | `isDisabledBoolean()` | REMOVED | NECESSARY — Architecture | No — inherited |
| 8 | `setDisabled(boolean)` | REMOVED | NECESSARY — Architecture | No — inherited |
| 9 | `setNoRulers(boolean)` | Moved to ERTE | Not breaking | — |
| 10 | `isReadonlyBoolean()` | REMOVED | NECESSARY — Architecture | No — inherited |
| 11 | `setReadonly(boolean)` | REMOVED | NECESSARY — Architecture | No — inherited |
| 12 | `getI18nJsonArray()` | REMOVED | NECESSARY — Platform | No — elemental JSON |
| 13 | `setI18n(JsonArray)` | REMOVED | NECESSARY — Platform | No — elemental JSON |
| 14 | `ChangeEvent<R>` inner class | REMOVED | NECESSARY — Architecture | No — standard VCE |
| 15 | `addChangeListener(...)` | REMOVED | NECESSARY — Architecture | No — use `addValueChangeListener` |
| 16 | `AbstractPlaceholderEvent<R>` | REMOVED | NECESSARY — Architecture | No — generics gone |
| 17 | `AbstractMultiPlaceholderEvent<R>` generic | Non-generic | NECESSARY — Architecture | No |
| 18 | All events generic `<R>` | Non-generic | NECESSARY — Architecture | No |
| 19-26 | `protected addPlaceholder*Listener` (8) | `public` | Not breaking (widening) | — |
| 27-30 | Generated constructors (4) | REMOVED | NECESSARY — Architecture | No — internal |
| 31 | `focus()` (custom setTimeout) | REMOVED | NECESSARY — Architecture | No — inherited |

**Note on 2-3:** `addThemeVariants`/`removeThemeVariants` are inherited from parent `RichTextEditor`. Users switch from `EnhancedRichTextEditorVariant` to `RichTextEditorVariant` (same enum values). Not a breaking change in functionality, only an import change.

#### 2.2 EnhancedRichTextEditorVariant

| # | V24 Member | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `enum EnhancedRichTextEditorVariant` | REMOVED | NECESSARY — Architecture | No |
| 2 | `LUMO_NO_BORDER` | Replaced by `RichTextEditorVariant.LUMO_NO_BORDER` | NECESSARY — Architecture | No |
| 3 | `LUMO_COMPACT` | Replaced by `RichTextEditorVariant.LUMO_COMPACT` | NECESSARY — Architecture | No |
| 4 | `MATERIAL_NO_BORDER` | REMOVED (Material = Phase 6) | NECESSARY — Architecture | No |

**Not a rollback candidate.** The parent `RichTextEditor` provides `RichTextEditorVariant` with identical Lumo variants (`LUMO_COMPACT`, `LUMO_NO_BORDER`). ERTE inherits `addThemeVariants(RichTextEditorVariant...)` directly. Only the import changes: `EnhancedRichTextEditorVariant` → `RichTextEditorVariant`. Document in Upgrade Guide.

#### 2.3 TabConverter

| # | V24 Member | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `class TabConverter` | REMOVED | NECESSARY — Architecture | No |
| 2 | `convertIfNeeded(String)` | REMOVED | NECESSARY — Architecture | No |
| 3 | `convertToNewFormat(String)` | REMOVED | NECESSARY — Architecture | No |

**Why necessary:** TabConverter handled migration from pre-5.2.0 Delta format (tabs-cont blots). V25 uses HTML-primary, Quill 2 delta format is fundamentally different. Old deltas don't apply.

### 3. EnhancedRichTextEditor

#### 3.1 Constructors

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `ERTE()` | Uses parent no-arg | Not breaking (still works) | — |
| 2 | `ERTE(String initialValue)` | REMOVED | **UNNECESSARY — Oversight** | **R1 — Easy** |
| 3 | `ERTE(ValueChangeListener)` | REMOVED | **UNNECESSARY — Oversight** | **R1 — Easy** |
| 4 | `ERTE(String, ValueChangeListener)` | REMOVED | **UNNECESSARY — Oversight** | **R1 — Easy** |

**Why unnecessary:** These are standard convenience constructors. The parent `RichTextEditor` only has a no-arg constructor, but ERTE can easily add:
```java
public EnhancedRichTextEditor(String initialValue) { this(); setValue(initialValue); }
public EnhancedRichTextEditor(ValueChangeListener<...> listener) { this(); addValueChangeListener(listener); }
public EnhancedRichTextEditor(String initialValue, ValueChangeListener<...> listener) { this(); setValue(initialValue); addValueChangeListener(listener); }
```

**Note:** V25 `setValue(String)` accepts HTML (not Delta). So `new ERTE(htmlString)` would set HTML. This is consistent with V25 semantics but different from V24's `new ERTE(deltaJson)`. The constructor is still useful — just the format changed.

#### 3.2 Value and Content API

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `setValue(String)` Delta-primary | HTML-primary | NECESSARY — Architecture | No |
| 2 | `getValue()` returns Delta | Returns HTML | NECESSARY — Architecture | No |
| 3 | `getHtmlValue()` | REMOVED | NECESSARY — Architecture (V25 is HTML-primary, `getValue()` returns HTML) | No |
| 4 | `sanitize(String)` pkg-private | `erteSanitize(String)` protected static | NECESSARY — Architecture | No |
| 5 | `int getTextLength()` sync | `void getTextLength(Consumer)` async | NECESSARY — Architecture | No |
| 6 | `setValueChangeMode(VCM)` | REMOVED (inherited from parent) | NECESSARY — Architecture | No |
| 7 | `getValueChangeMode()` | REMOVED (inherited from parent) | NECESSARY — Architecture | No |

**getHtmlValue() entfernt:** In V25 ist HTML das primäre Format — `getValue()` liefert bereits sanitized HTML. `getHtmlValue()` wäre redundant. Im Upgrade Guide als fundamentale Architektur-Änderung dokumentieren.

#### 3.3 I18n

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `getI18n()` / `setI18n(RichTextEditorI18n)` | Use parent methods | NECESSARY — Architecture | No |
| 2 | Inner class `RichTextEditorI18n` | `EnhancedRichTextEditorI18n extends parent.I18n` | NECESSARY — Architecture | No |
| 3 | `getDeindent()` / `setDeindent()` | `getOutdent()` / `setOutdent()` | NECESSARY — Platform (RTE 2 renamed) | No |
| 4 | `setPlaceholderAppeance()` (typo) | `setPlaceholderAppearance()` | NECESSARY — Bugfix | No |
| 5-7 | Swapped getter/setter names | Fixed | NECESSARY — Bugfix | No |
| 8 | Setters return `RichTextEditorI18n` | Return `EnhancedRichTextEditorI18n` | NECESSARY — Architecture | No |

#### 3.4 Keyboard Shortcuts

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `addStdToolbarButtonShortcut(..., Number keyCode, Boolean, Boolean, Boolean)` | `(..., String key, boolean, boolean, boolean)` | NECESSARY — Quill 2 (`Number keyCode` → `String key`) + no `null` semantics for `Boolean` | No |
| 2 | `addToobarFocusShortcut(Number, Boolean, Boolean, Boolean)` (typo) | `addToolbarFocusShortcut(String, boolean, boolean, boolean)` | NECESSARY — Bugfix + Quill 2 | No |

#### 3.5 Placeholder API

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `setPlaceholders(Collection<Placeholder>)` | `setPlaceholders(List<Placeholder>)` | **UNNECESSARY — Optimization** | **R2 — Easy** |
| 2 | `Collection<Placeholder> getPlaceholders()` | `List<Placeholder> getPlaceholders()` | Not breaking (more specific return) | — |
| 3 | `getPlaceholderAltAppearancePattern()` | REMOVED | **UNNECESSARY — Oversight** | **R3 — Easy** |
| 4 | `setPlacehoderAltAppearance()` (typo) | `setPlaceholderAltAppearance()` | NECESSARY — Bugfix | No |
| 5 | `isPlacehoderAltAppearance()` (typo) | `isPlaceholderAltAppearance()` | NECESSARY — Bugfix | No |
| 6 | `protected getPlaceholder(p)` returns null | Returns input if not found | NECESSARY — Bugfix | No |

**R2:** `Collection` → `List` is an unnecessary parameter narrowing. Code like `editor.setPlaceholders(mySet)` breaks. Easy fix: change parameter back to `Collection<Placeholder>`.

**R3:** `getPlaceholderAltAppearancePattern()` was a simple getter for a stored property. No reason to remove it. The setter exists, so the getter should too.

#### 3.6 Deprecated Methods (all removed)

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1-5 | `@Deprecated addCustomButton`, `addCustomButtons`, `getCustomButton`, `removeCustomButton` (×2) | REMOVED | NECESSARY — Bugfix (deprecation cycle complete) | No |

#### 3.7 Other

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `runBeforeClientResponse` pkg-private | `protected` | Not breaking (widening) | — |
| 2 | `replaceStandardToolbarButtonIcon` calls `getButtonName()` internally | Calls `getPartSuffix()` | Not breaking (internal) | — |

### 4. ToolbarButton Enum

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `DEINDENT` | `OUTDENT` | NECESSARY — Platform (RTE 2 renamed) | No |
| 2 | `getButtonName()` | `getPartSuffix()` | **UNNECESSARY — Optimization** | **R7 — Easy** |
| 3 | `PLACEHOLDER_APPEARANCE` → `"placeholderAppearance"` | `"placeholder-display"` | NECESSARY — Architecture (kebab-case) | No |
| 4 | Parameterless constructor | `ToolbarButton(String)` | Not breaking (enum) | — |
| 5 | 28 values | 30 values (+COLOR, +BACKGROUND) | Not breaking (additive) | — |

**R7:** `getButtonName()` was a public method used externally. `getPartSuffix()` is a better name but breaks existing code. Solution: keep `getPartSuffix()` as primary, add `@Deprecated getButtonName()` that delegates:
```java
@Deprecated
public String getButtonName() { return getPartSuffix(); }
```

### 5. Placeholder Class

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `implements JsonSerializable` | `implements Serializable` | NECESSARY — Platform | No |
| 2 | `Placeholder(JsonObject)` | `Placeholder(JsonNode)` | NECESSARY — Platform | No |
| 3 | `JsonObject getFormat()` | `Map<String, Object> getFormat()` | NECESSARY — Platform | No |
| 4 | `setFormat(JsonObject)` | `setFormat(Map<String, Object>)` | NECESSARY — Platform | No |
| 5 | `JsonObject getAltFormat()` | `Map<String, Object> getAltFormat()` | NECESSARY — Platform | No |
| 6 | `setAltFormat(JsonObject)` | `setAltFormat(Map<String, Object>)` | NECESSARY — Platform | No |
| 7 | `JsonObject toJson()` | `ObjectNode toJson()` | NECESSARY — Platform | No |
| 8 | `readJson(JsonObject)` | REMOVED | NECESSARY — Platform | No |

**Note:** All Placeholder changes are forced by Jackson 3 (Vaadin 25 removes elemental JSON). The `Map<String,Object>` choice for format/altFormat is actually an improvement — more framework-agnostic.

### 6. TabStop Class

No breaking changes.

### 7. SlotUtil

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `public class SlotUtil` (non-final) | `public final class` (private ctor) | **UNNECESSARY — Optimization** | Low impact |
| 2 | `@Deprecated addButton(ERTE, Button)` | REMOVED | NECESSARY — Bugfix (deprecated) | No |
| 3 | `addComponent(ERTE, Component)` (2-arg) | REMOVED | **UNNECESSARY — Optimization** | **R4 — Easy** |
| 4 | `addComponentAtIndex(ERTE, Component, int)` (3-arg) | REMOVED | **UNNECESSARY — Optimization** | **R5 — Easy** |
| 5 | `removeButton(ERTE, String)` | REMOVED | NECESSARY — Architecture (should have been deprecated alongside `addButton`) | No |
| 6 | `removeButton(ERTE, Button)` | REMOVED | NECESSARY — Architecture (same) | No |
| 7 | `getButton(ERTE, String)` | REMOVED | NECESSARY — Architecture (same) | No |
| 8 | `replaceStandardButtonIcon` icon=null behavior | Now allows null (clears slot) | NECESSARY — Bugfix (improvement) | No |

**R4-R6:** These are simple convenience delegates:
```java
// R4
public static void addComponent(ERTE target, Component c) {
    addComponent(target, CUSTOM_GROUP_SLOTNAME, c);
}
// R5
public static void addComponentAtIndex(ERTE target, Component c, int index) {
    addComponentAtIndex(target, CUSTOM_GROUP_SLOTNAME, c, index);
}
// R6
public static void removeButton(ERTE target, String id) { removeComponent(target, CUSTOM_GROUP_SLOTNAME, id); }
public static void removeButton(ERTE target, Button b) { removeComponent(target, CUSTOM_GROUP_SLOTNAME, b); }
public static Button getButton(ERTE target, String id) { return (Button) getComponent(target, CUSTOM_GROUP_SLOTNAME, id); }
```

### 8. ToolbarSlot Enum

No breaking changes (only additive: +BEFORE_GROUP_STYLE, +AFTER_GROUP_STYLE).

### 9-12. Toolbar Helper Classes

**ToolbarPopover, ToolbarSelectPopup, ToolbarDialog, ToolbarSwitch** — no public API breaking changes.

### 13. Placeholder Event Classes

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `AbstractPlaceholderEvent<R>` | REMOVED | NECESSARY — Architecture | No |
| 2 | `AbstractMultiPlaceholderEvent<R>` generic | Non-generic, `JsonNode` | NECESSARY — Platform + Architecture | No |
| 3 | All event constructors `JsonObject` | `ObjectNode` | NECESSARY — Platform | No |
| 4 | All events generic `<R>` | Non-generic | NECESSARY — Architecture | No |

### 14. Tables: EnhancedRichTextEditorTables

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `setTemplates(JsonObject)` | `setTemplates(ObjectNode)` | NECESSARY — Platform | No |
| 2 | `JsonObject getTemplates()` | `ObjectNode getTemplates()` | NECESSARY — Platform | No |
| 3 | `TemplatesInitialiazedEvent` (typo) | `TemplatesInitializedEvent` | NECESSARY — Bugfix | No |
| 4-9 | No color/action validation | Validates inputs | NECESSARY — Bugfix/Security | No |

### 15. Tables: TemplateParser

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `convertToCss(JsonObject)` | `convertToCss(ObjectNode)` | NECESSARY — Platform | No |
| 2 | `convertToCss(String)` | Same | — | — |
| 3 | `parseJson(String)` → `JsonObject` | → `ObjectNode` | NECESSARY — Platform | No |
| 4 | `parseJson(String, boolean)` → `JsonObject` | → `ObjectNode` | NECESSARY — Platform | No |
| 5 | `TemplateParser(JsonObject)` | `TemplateParser(ObjectNode)` | NECESSARY — Platform | No |
| 6 | `toCss()` | Same | — | — |
| 7 | `isValidTemplateId(String)` | Same | — | — |
| 8 | `isValidColor(String)` | **MOVED to `TemplateJsonConstants`** | **UNNECESSARY — Optimization** | **R8 — Easy** |
| 9 | `removeEmptyChildren(JsonObject)` | `removeEmptyChildren(ObjectNode)` | NECESSARY — Platform | No |
| 10 | `searchForIndexedObject(JsonArray, String, boolean)` | `searchForIndexedObject(ArrayNode, String, boolean)` | NECESSARY — Platform | No |
| 11 | `clone(JsonObject)` | `clone(ObjectNode)` | NECESSARY — Platform | No |

**R8:** `isValidColor` was a public method on `TemplateParser`. Moving it to `TemplateJsonConstants` is unnecessary — external code calling `TemplateParser.isValidColor("red")` breaks. Easy fix: add delegate in `TemplateParser`:
```java
@Deprecated
public static boolean isValidColor(String color) {
    return TemplateJsonConstants.isValidColor(color);
}
```

### 16. Tables: Template Events

| # | V24 Signature | V25 Status | Category | Rollback? |
|---|---|---|---|---|
| 1 | `TemplatesInitialiazedEvent` | `TemplatesInitializedEvent` | NECESSARY — Bugfix | No |
| 2-5 | `JsonObject` params/returns | `ObjectNode` | NECESSARY — Platform | No |

### 17. Tables: TablesI18n

No breaking changes.

### 18. CSS Custom Properties

All V25 `--vaadin-erte-*` properties are **additive** (new). Not breaking.

### 19. Part Names

| # | V24 Part | V25 Part | Category | Rollback? |
|---|---|---|---|---|
| 1 | `deindent-button` | `toolbar-button-outdent` | NECESSARY — Platform (RTE 2 naming) | No |
| 2 | `{name}-button` convention | `toolbar-button-{name}` convention | NECESSARY — Architecture | No |

**Note:** Part name changes only affect external CSS using `::part()`. The V25 naming follows RTE 2's convention.

### 20. JSON Library (Cross-Cutting)

ALL `elemental.json.*` → `tools.jackson.*` changes are **NECESSARY — Platform** (Vaadin 25 removed elemental JSON).

---

## Rollback Implementation Plan

All 11 rollbacks are **easy** (1-10 lines each, no architectural changes). They can be implemented in a single commit.

### R1 — Constructors
Add 3 convenience constructors to `EnhancedRichTextEditor`.

### R2 — setPlaceholders parameter
Change `List<Placeholder>` back to `Collection<Placeholder>`.

### R3 — getPlaceholderAltAppearancePattern
Add the getter back (reads from cached field or element property).

### R4-R5 — SlotUtil convenience overloads
Add back the 2-arg convenience overloads as simple delegates to the slot-aware methods.

### R7 — ToolbarButton.getButtonName()
Add `@Deprecated getButtonName()` delegating to `getPartSuffix()`.

### R8 — TemplateParser.isValidColor()
Add `@Deprecated` delegate to `TemplateJsonConstants.isValidColor()`.


