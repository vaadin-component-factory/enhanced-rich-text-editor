# Phase 3.3c: Security Hardening — HTML Sanitization (Feature 11)

## Status: COMPLETE

## What Was Done

### 1. Style Attribute Filtering (`filterStyleAttributes()`)
- Whitelist of ~50 safe CSS properties (text, layout, spacing, box, border, display, size, position)
- Whitelist of safe CSS functions: `rgb()`, `rgba()`, `hsl()`, `hsla()`, `calc()`
- Blocks dangerous functions: `url()`, `expression()`, `behavior()`, `var()`, etc. (whitelist approach)
- Strips CSS comments (`/* ... */`) before processing
- Strips `@import` directives regardless of syntax
- Removes empty `style=""` attributes entirely
- Preserves `float` property (Quill 2 image alignment)

### 2. Data URL MIME Restriction (`filterDataUrls()`)
- Safe MIME whitelist: `image/png`, `image/jpeg`, `image/jpg`, `image/gif`, `image/webp`, `image/bmp`, `image/x-icon`
- Blocks `image/svg+xml` (SVG can contain scripts)
- Blocks `text/html`, `application/javascript`, `text/xml`, bare `data:` URLs
- Case-insensitive MIME matching, handles optional whitespace after `data:`

### 3. contenteditable Hardening
- Added `contenteditable=""` stripping (empty string equals `true` in HTML)

### 4. Safelist Fixes (discovered during testing)
- Moved `class` attribute from `span`-only to `:all` scope (Quill puts alignment classes on `<p>`)
- Added `http` and `https` protocols for `img[src]` (was missing, only `data` was there)

## Test Results
- **41 JUnit tests** pass (new `RteExtensionBaseSanitizeTest.java`)
  - StyleFiltering: 16 tests
  - DataUrlFiltering: 10 tests
  - ClassFiltering: 4 tests
  - XssStripping: 4 tests
  - NullEmpty: 2 tests
  - RealWorldFormatting: 5 tests
- **189 Playwright tests** pass (ERTE suite), 11 skipped (fixme), 6 fail (pre-existing)
- **8 new Playwright sanitizer integration tests** (tests 25-32 in features.spec.ts) — all pass

## Files Changed
- `RteExtensionBase.java` — added `filterStyleAttributes()`, `filterDataUrls()`, contenteditable="" fix, safelist improvements
- `RteExtensionBaseSanitizeTest.java` — **new** JUnit 5 test class (41 tests)
- `ErteFeatureTestView.java` — added TextArea + "Set HTML" button for round-trip testing
- `features.spec.ts` — 8 new sanitizer integration tests + `setAndGetHtml()` helper
