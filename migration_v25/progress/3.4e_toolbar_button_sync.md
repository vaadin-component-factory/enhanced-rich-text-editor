# Phase 3.4e: Toolbar Button State Synchronization

**Status:** ATTEMPTED - NOT SOLVABLE WITH CURRENT APPROACH
**Date:** 2026-02-21
**Issue:** GitHub vaadin/web-components#11184

## Problem Description

Toolbar buttons in RTE 2 display formatting state from the **previous** cursor position rather than the current one. This "one event behind" behavior affects all toggle buttons (bold, italic, link, alignment, etc.).

**Example:**
- Content: "Hello **world**" (where "world" is bold)
- After pressing Home key (cursor at position 0, before "Hello")
- Expected: Bold button NOT active (cursor is in plain text)
- Actual: Bold button STILL active (showing format from previous position)

## Root Cause Analysis

The issue is a **fundamental limitation in Quill 2's format query logic** at cursor boundaries:

1. When `getFormat(index, 0)` is called with zero-length range (cursor), Quill returns the format that would be applied to **new text** typed at that position
2. This format is based on the **previous character's format**, not the character at the cursor position
3. At format boundaries, this causes toolbar buttons to show the "old" format for one cursor movement

**Not an ERTE bug** - this is how Quill 2's `getFormat()` semantics work.

## Fix Attempts

### Attempt 1: Direct toolbar.update() call
```javascript
this._editor.on('selection-change', (range) => {
  toolbar.update(range);
});
```
**Result:** Introduced new bug - align left button shows as active for text with no explicit alignment

### Attempt 2: Deferred update with requestAnimationFrame
```javascript
this._editor.on('selection-change', (range) => {
  requestAnimationFrame(() => toolbar.update(range));
});
```
**Result:** Still showed lag in manual testing

### Attempt 3: Query character AT cursor (length: 1)
```javascript
const queryRange = range.length === 0 && range.index < this._editor.getLength() - 1
  ? { index: range.index, length: 1 }
  : range;
toolbar.update(queryRange);
```
**Result:** Worked in manual UI testing ✓ but failed in Playwright tests ✗

## Investigation Results

- **UI Explorer (manual testing):** Fix appeared to work, aria-pressed attributes correct
- **Playwright automated tests:** Fix did not work, buttons still lagged
- **Discrepancy:** Suggests timing issues or differences in how manual vs automated testing interact with Quill's event system

## Conclusion

This issue **cannot be fixed at the ERTE level** with current approach. The problem requires either:

1. **Upstream fix in Vaadin RTE 2** - Patch Quill's toolbar module to handle boundary positions correctly
2. **Upstream fix in Quill 2** - Change `getFormat()` semantics for zero-length ranges
3. **Complete custom toolbar** - Implement ERTE's own toolbar button state management (significant effort)

## Recommendation

- **Document as known limitation** in ERTE documentation
- **File issue with Vaadin** to fix in RTE 2 upstream
- **Mark as deferred** until upstream fix is available

## Changes Made

All attempted fixes were **reverted** - no code changes committed.

Files affected (all reverted):
- `enhanced-rich-text-editor-v25/src/main/resources/META-INF/resources/frontend/vcf-enhanced-rich-text-editor.js`
- `enhanced-rich-text-editor-demo/tests/erte/button-sync.spec.ts` (deleted)

## Test Results

Phase 3.4e **NOT COMPLETED** - issue remains unfixed.
