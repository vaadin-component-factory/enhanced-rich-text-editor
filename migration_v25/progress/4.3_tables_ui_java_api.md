# Phase 4.3: Tables UI Controls & Java API

**Status:** IN PROGRESS (4.3a COMPLETE, 4.3b COMPLETE, sanitizer fix uncommitted)

## Phase 4.3a: Table Operations, CSS, Connector & Java API — COMPLETE

**Completed:** 2026-02-24

### What was implemented

**JS Files Created:**
- `TableTrick.js` — All table manipulation operations (insert, remove, add/remove row/col, merge, split, border toggle, undo/redo dispatch). Parchment 3 adapted (`quill.scroll.create()`, `Quill.find()`). Security: `CSS.escape()` for selectors, template name validation.
- `TableSelection.js` — Cell multi-selection via Ctrl+Drag. Events: `table-selected` (CustomEvent), `table-cell-changed` (CustomEvent with oldRow/oldCol tracking).
- `TableHistory.js` — Table undo/redo with DOM-level operations (insert, remove, split, merge, propertyChange).

**JS Files Modified:**
- `TableModule.js` — Full keyboard bindings: Backspace (cell boundary protection), Delete (prevent crossing boundary), Ctrl+A (cell-only select), Undo/Redo (table history dispatch), Escape (clear cell selection).
- `connector.js` — Full connector: CSS injection into shadow root, `init()`, `insert()`, `action()`, `setTemplate()`, `_setStyles()`, `_setCustomStyles()`. All use `textContent` (not innerHTML). Mouse event wiring for cell selection.
- `erte-table-styles.css` — Lumo token replacements, cell selection highlight, focus outline, hidden border, merged cell hiding.

**Java Files Modified:**
- `EnhancedRichTextEditorTables.java` — Full implementation: toolbar integration (ToolbarSwitch + ToolbarPopover + ToolbarSelectPopup), Jackson 3 event data, action whitelist validation, color validation, template button (disabled, stub for 4.3b).
- `TemplateJsonConstants.java` — Security fixes: color pattern regex bugs, added `PATTERN_P_COLOR_5` for CSS custom properties, added `isValidColor()` method.
- `TemplateParser.java` — Security TODO for Phase 4.3b.
- `ErteTablesTestView.java` — Event log output for TableSelectedEvent and TableCellChangedEvent.
- `ErteTestLayout.java` — Updated nav link.

### Verification Results

**Regression tests:** 210 passed, 4 failed (all pre-existing screenshot tests), 10 skipped. **No regressions from Phase 4.3a.**

**Manual Playwright verification:**
- [x] Table insertion (3x3 via toolbar popover)
- [x] Add row (Append row below)
- [x] Tab navigation between cells
- [x] Cell selection (Ctrl+Drag over 3 cells — blue highlight)
- [x] Merge cells (3 cells → 1 with colspan=3, hidden merge cells)
- [x] Remove table (editor empty, toolbar state correct)
- [x] Undo (table history — removed table restored)
- [x] Events fire correctly (TableSelected, CellChanged with old coords)
- [x] Toolbar state (Add enabled when no table, Modify/Style enabled when in table, Merge disabled without cell selection)
- [x] CSS (borders, cell selection highlight, focus outline)

### Known Limitations
- Table History undo/redo restores tables but may produce slightly different row ordering (known V24 behavior — DOM-level history doesn't perfectly track Quill optimize cycles)
- Merge via menu requires Ctrl+Drag selection first (single Ctrl+Click selects one cell only)

---

## Phase 4.3b: Template System — COMPLETE

**Completed:** 2026-02-24

### What was implemented

**TemplateParser.java** — Full CSS generation from Jackson 3 ObjectNode templates:
- Instance-based parser with `toCss()` entry point
- `parseTable()`, `parseRows()`, `parseCols()`, `parseCells()` — CSS selector builders
- `parseDeclarations()`, `appendDeclaration()`, `appendIndex()`, `appendXY()`, `mapToCss()` — helpers
- `removeEmptyChildren()` — recursive JSON cleanup (backward array iteration)
- `searchForIndexedObject()` — finds row/col by index in array
- **Security:** `isValidPropertyValue()`, `isValidSize()`, `isValidBorder()` — validates all CSS values before output. Rejects CSS injection characters, unknown functions, dangerous content.
- Static `convertToCss(ObjectNode)` convenience method, null-safe

**TemplateDialog.java** — Full CRUD dialog for template editing:
- Template selection ComboBox + name TextField with Binder validation
- Create/Copy/Delete buttons with proper state management
- 7 form part sections in Details containers (table, current row/col, specific row/col headers/footers, even/odd rows)
- `Defaults` inner class with change listeners for dimension unit synchronization
- ConfirmDialog for delete with V25 builder pattern
- Row/col index tracking on add/remove
- Accessible close button with `setAriaLabel("Close dialog")`

**RuleFormPart hierarchy (6 files):**
- `RuleFormPart.java` — Base with field factories (`createTextField`, `createBorderField`, `createColorField`, `createSizeField`), getter/setter lambdas for Jackson ObjectNode, `clearValues()`, `addValueChangeListener()`
- `DefaultPropertiesFormPart.java` — Standard form layout (color, bgColor, border, optional width/height)
- `AbstractIndexedFormPart.java` — `readTemplate()` with index lookup and auto-create using `JsonNodeFactory.instance`
- `TableFormPart.java` — 4-field form (color, bgColor, tableBorder, cellsBorder)

**Bug fixes for delta loading:**
1. `TableModule.js` — Strip `table`/`tr` clipboard format attributes in TABLE matcher. Quill's clipboard adds `table: N` (numeric counter) that causes `Table.create(N)` to use random IDs, conflicting with correct IDs from `td` format.
2. `RteExtensionBase.java` — Skip `dangerouslySetHtmlValue` when delta value is already set. Prevents HTML roundtrip from overwriting correctly-applied delta content, preserving template classes and table structure.

**Test view updates:**
- `ErteTablesTestView.java` — Load sample templates, read/write template JSON, template CRUD buttons
- `table-sample-delta.json` — Fixed formatting

### Root cause analysis: delta loading bug

Two issues caused cell "1" to be orphaned into a separate table:

1. **`setPresentationValue("")` scheduling:** `AbstractSinglePropertyField` default triggers `dangerouslySetHtmlValue("")` via `runBeforeClientResponse`, clearing the editor AFTER delta was correctly applied by `_valueChanged`.

2. **Clipboard `table: N` format:** `dangerouslySetHtmlValue(html)` uses `clipboard.convert()` which produces `table: 1` (numeric) alongside correct `td` format. `Table.create(1)` with non-string value takes auto-wrapping path → random `table_id`.

### Verification

**Regression tests:** 214 passed, 10 skipped, 0 failed (matches baseline).

**Manual verification:**
- [x] Table loads correctly from delta (1 table, 30 cells, 6 rows)
- [x] Template class "template1" applied to table element
- [x] Cell IDs preserved correctly through delta loading
- [x] TemplateParser generates correct CSS from template JSON
- [x] CSS security validation rejects injection attempts

### Open issues (post-4.3b)

1. ~~**Initial HTML output shows paragraphs:**~~ **RESOLVED** — Fixed by `setModelValue()` override that calls `erteSanitize()` instead of parent's `sanitize()` (commit `d450d511`), plus `setPresentationValue()` skip-delta logic that avoids `dangerouslySetHtmlValue` when delta content is already applied (commit `21ac993c`). Tables now survive the HTML round-trip correctly.

2. **V24 API completeness audit:** V24 `TemplateParser` had `convertToCss(String templateJson)` which was dropped in V25. Need thorough audit of ALL V24 public API methods across all template classes to ensure no unnecessary breaking changes. Missing methods must be re-added with Jackson 3 equivalents.

3. ~~**Playground templates:**~~ **RESOLVED** — Sample templates loaded in `ErtePlaygroundView` (committed in `4fc3c8b0`).

---

## Sanitizer Fix: Dynamic Allowed HTML Classes — NOT YET COMMITTED

**Problem:** Tables addon registers template CSS classes (e.g., `template1`, `headerRow`) that the ERTE sanitizer strips because they're not in the static `ERTE_PRESERVED_CLASSES` list. Adding them statically is wrong — template names are user-defined.

**Solution:** Dynamic allowed classes API on `EnhancedRichTextEditor`:

**New Java API:**
- `addAllowedHtmlClasses(String... classNames)` — adds classes to the dynamic allow-list (validated: lowercase alphanumeric + hyphens only)
- `removeAllowedHtmlClasses(String... classNames)` — removes classes from the allow-list
- `getAllowedHtmlClasses()` — returns unmodifiable set of currently allowed classes

**Tables integration:**
- `EnhancedRichTextEditorTables.updateAllowedTemplateClasses()` — extracts all CSS class names from current templates and registers them via `addAllowedHtmlClasses()`
- Called automatically when templates change via `setTemplates()`

**Sanitizer chain:**
- Client-side: `__updateHtmlValue()` checks dynamic classes (synced from Java via `allowedHtmlClasses` property) alongside static `ERTE_PRESERVED_CLASSES`
- Server-side: `erteSanitize()` in `EnhancedRichTextEditor` adds dynamic classes to jsoup Safelist

**Unit tests (14 new):**
- 7 DynamicAllowedClasses tests: add, remove, getAll, duplicate handling, sync to client, sanitizer integration, clear-all
- 7 ClassNameValidation tests: valid names, reject invalid chars, reject empty/null, reject XSS, case sensitivity, hyphen rules, length limit
