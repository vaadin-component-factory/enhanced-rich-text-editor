# Phase 3.1a: Custom Slots / Toolbar Slot System (Feature 8)

## Status: COMPLETE

## Feature Summary
25 named `<slot>` elements in toolbar: START, END, BEFORE/AFTER for 11 groups (including RTE 2's style group) + GROUP_CUSTOM.
Java API: `addToolbarComponents(slot, components)`, `ToolbarSlot` enum, `SlotUtil`.

## Dependencies
- Phase 2 (ERTE Shell) — COMPLETE

## Key References
- USE_CASE_ANALYSIS.md Feature 8
- Spike Items: 4 (render override), 5 (custom buttons survive re-renders)
- V24 source: `SlotUtil.java`, `ToolbarSlot.java`
- RTE 2 source: `node_modules/@vaadin/rich-text-editor/src/vaadin-rich-text-editor.js` (render() at lines 145–407)

---

## Implementation (2026-02-19)

### Files Created
| File | Purpose |
|------|---------|
| `enhanced-rich-text-editor-v25/.../toolbar/ToolbarSlot.java` | Enum: 27 slot names |
| `enhanced-rich-text-editor-v25/.../toolbar/ToolbarSwitch.java` | Toggle button (extends Button) |
| `enhanced-rich-text-editor-v25/.../SlotUtil.java` | Static helpers for slot management |
| `enhanced-rich-text-editor-demo/.../ErteToolbarTestView.java` | Test view at `/erte-test/toolbar` |

### Files Modified
| File | Changes |
|------|---------|
| `vcf-enhanced-rich-text-editor.js` | `_injectToolbarSlots()` in `ready()` |
| `EnhancedRichTextEditor.java` | Toolbar component API methods |
| `toolbar.spec.ts` | 25 slot names, `outdent`, fixme for later phases |

### Test Results
- **Toolbar tests:** 20 passed, 5 skipped (fixme for phases 3.2a, 3.2b, 3.3g)
- **Shell tests:** 6 passed
- **Total:** 26 passed, 0 failures, 5 fixme

### Cross-cutting Findings
- **V25 RTE 2 uses `aria-label` (not `title`)** for i18n button labels — tests should assert `aria-label`
- **V25 `deindent` → `outdent`** in toolbar button part names
- **Slot count: 25 injected DOM slots, 27 Java enum values** (26 named + 1 "toolbar" legacy name for GROUP_CUSTOM)

---

## Critical Investigation: render() Approach (2026-02-19)

### Question
Should ERTE copy the entire RTE 2 toolbar template in its `render()` override, or dynamically inject `<slot>` elements into the DOM produced by `super.render()`?

### Constraint
CLAUDE.md Golden Rule #2: "Updatability over convenience. Never copy RTE 2 source code. Extend at runtime." If we copy the template, every RTE 2 toolbar change (new button, group reorder, etc.) requires a manual ERTE update.

### Investigation Method
Practical browser test on running ERTE V25 shell:
1. `super.render()` produces the toolbar (11 groups, standard buttons)
2. In JavaScript, `<slot>` elements are injected between toolbar groups via DOM API
3. Lit re-renders are triggered (`i18n` change + `requestUpdate()`)
4. Check if injected slots survive

### Results: PASS — Dynamic injection works!

| Scenario | Slots survive? | Proof |
|----------|:-:|------|
| Initial injection (25 slots around 11 groups) | **YES** | 25/25 present |
| 5x rapid `requestUpdate()` | **YES** | 25/25, i18n label updated |
| `readonly=true` → toolbar hidden | **YES** | 25/25, toolbar still in DOM |
| `readonly=false` → toolbar visible again | **YES** | 25/25 |
| Quill `setText()` | **YES** | 25/25 |
| Light-DOM button in `toolbar-start` slot | **YES** | Visible, in toolbar area, survives re-render |
| Light-DOM button in `toolbar-after-group-emphasis` slot | **YES** | Visible, in toolbar area, survives re-render |

### Why this works (technical explanation)
Lit's template diffing uses comment marker nodes (`<!--?lit$...-->`) to track expression boundaries. DOM nodes inserted BETWEEN these markers are invisible to Lit's diffing — they are neither created nor destroyed by Lit. As long as:
1. The template structure from `super.render()` doesn't change (same number of expressions, same template string)
2. Injected nodes are placed between existing template-managed elements (not inside expression boundaries)

...Lit will leave them alone during re-renders.

### Decided Approach: `super.render()` + DOM injection in `ready()`

### Advantages over template copy
1. **Automatic inheritance:** If RTE 2 adds a new button to an existing group, ERTE gets it for free
2. **No template maintenance:** No need to manually sync ERTE's template with RTE 2 updates
3. **Updatability:** Matches Golden Rule #2
4. **Less code:** ~40 lines of slot injection vs ~300 lines of template copy

### Limitations
1. If RTE 2 adds a NEW group (not a button in existing group), ERTE won't automatically add BEFORE/AFTER slots for it. This is acceptable — new groups are rare (style group was the only addition in V25).
2. ERTE-specific buttons (readonly, whitespace, etc.) still need to be injected via DOM API in their respective subphases.
3. Slot injection runs in `ready()`, which fires once. If RTE 2's toolbar is rebuilt from scratch (unlikely), slots would be lost. Verified: this doesn't happen with normal re-renders.

### RTE 2 Toolbar Groups (11 total, from practical inspection)
```
toolbar-group-history           (undo, redo)
toolbar-group-emphasis          (bold, italic, underline, strike)
toolbar-group-style             (color, background)          ← NEW in RTE 2
toolbar-group-heading           (h1, h2, h3)
toolbar-group-glyph-transformation  (subscript, superscript)
toolbar-group-list              (list-ordered, list-bullet)
toolbar-group-indent            (outdent, indent)            ← V24 used "deindent"
toolbar-group-alignment         (align-left, align-center, align-right)
toolbar-group-rich-text         (image, link)
toolbar-group-block             (blockquote, code-block)
toolbar-group-format            (clean)
```

### Enum: 27 values
- V24: START + 10 groups × 2 + BEFORE_CUSTOM + GROUP_CUSTOM + AFTER_CUSTOM + END = 25
- V25: START + 11 groups × 2 + BEFORE_CUSTOM + GROUP_CUSTOM + AFTER_CUSTOM + END = 27

---

## Acceptance Criteria
- [x] `ready()` injects 25 `<slot>` elements into toolbar DOM via `_injectToolbarSlots()`
- [x] `render()` calls `super.render()` — NO template copy
- [x] Java `ToolbarSlot` enum with 27 values (25 V24 slots + 2 new for style group)
- [x] `SlotUtil` class with add/remove/get component methods
- [x] `addToolbarComponents(slot, components...)` Java API on `EnhancedRichTextEditor`
- [x] Custom Vaadin components render in correct toolbar positions
- [x] Standard RTE 2 toolbar buttons unchanged (all icons, labels, functionality preserved)
- [x] Slots survive Lit re-renders (i18n change, readonly toggle)
- [x] Playwright tests for slot insertion and positioning
