# Phase 3.1f: Placeholders (Feature 5)

## Status: COMPLETE (2026-02-20)

## Test Results
- **Placeholder tests:** 30 pass, 2 fixme (copy-paste, undo-remove — Quill 2 embed limitations)
- **Regression tests:** 109 pass, 20 fixme (baseline maintained)

## What Was Implemented

### JS (vcf-enhanced-rich-text-editor.js)
1. **PlaceholderBlot** — Quill 2 Embed blot (`<span class="ql-placeholder">`) with:
   - `static create(value)` → stores value as `data-placeholder` JSON
   - `constructor()` → calls `setText()` and `applyFormat()` (NOT in `create()` — contentNode doesn't exist yet)
   - Normal appearance: `@tag_start + text + tag_end`
   - Alt appearance: regex-matched portion in separate `<span alt>` with altFormat
   - Format/altFormat support: bold, italic, underline, strike, font, link, script
   - Guard node aware — does NOT set `contenteditable="false"` on outer domNode

2. **Confirm dialog** — `vaadin-confirm-dialog` + `vaadin-combo-box`:
   - Created in `_createPlaceholderDialog()` → singleton in shadow DOM
   - `rejectButtonVisible` toggled alongside button hidden (Vaadin V25 requirement)
   - Edit mode (existing placeholder) vs Insert mode (new)
   - `_dialogJustClosed` flag prevents false edit-mode detection after consecutive inserts

3. **Toolbar buttons** — Placeholder insert (`@`) + toggle appearance (`Plain`/`Formatted`)
4. **Keyboard shortcut** — Ctrl+P/Cmd+P via direct `ctrlKey`/`metaKey` binding (NOT `shortKey`)
5. **Selection tracking** — `selection-change` handler dispatches `placeholder-select`/`placeholder-leave`
6. **Click handler** — Mousedown on `.ql-placeholder` calls `e.preventDefault()` + deferred `setSelection()` via `setTimeout(0)` (contenteditable="false" embeds don't trigger native selection-change)
7. **Sanitizer** — `ERTE_PRESERVED_CLASSES` updated with `'ql-placeholder'`

### Java (EnhancedRichTextEditor.java + Placeholder.java)
1. **Placeholder class** — POJO with text, format, altFormat, index fields
2. **8 event classes** — PlaceholderButtonClicked, BeforeInsert, Inserted, BeforeRemove, Removed, Selected, Leave, AppearanceChanged
3. **Properties** — `placeholders`, `placeholderTags`, `placeholderAltAppearancePattern`, `placeholderAltAppearance`
4. **Server-side sanitizer** — `erteSanitize()` updated with `ql-placeholder` class + `data-placeholder` attribute

### Test View (ErtePlaceholderTestView.java)
- Single editor with 3 configured placeholders
- Auto-confirm toggles for insert/remove events
- Event log div with all 8 event listeners

### Test Spec (placeholders.spec.ts)
- 32 tests covering dialog, combo-box, insert, remove, formatting, tags, alt appearance, keyboard, events, batch operations

## Key Debugging Discoveries

### Quill 2 Embed Lifecycle (CRITICAL)
- `static create()` runs BEFORE the constructor. The Embed constructor creates guard nodes + `contentNode`.
- `setText()` must be called in `constructor()`, NOT in `create()` — `contentNode` is null in `create()`.

### Quill 2 `Keyboard.match()` vs `shortKey`
- `shortKey: true` is only resolved by `addBinding()`/`normalize()`. Direct `keyboard.bindings[key]` array manipulation bypasses this.
- Must use `[SHORTKEY]: true` where `SHORTKEY = /Mac/i.test(navigator.platform) ? 'metaKey' : 'ctrlKey'`.

### Vaadin 25 `vaadin-confirm-dialog`
- `rejectButtonVisible` property controls the reject-button slot independently of the button's `hidden` attribute.
- Setting `button.hidden = false` alone is insufficient — must also set `dialog.rejectButtonVisible = true`.

### contenteditable="false" Embed Click
- Clicking on contenteditable="false" content inside contenteditable="true" does NOT trigger Quill `selection-change`.
- Fix: `mousedown` handler with `e.preventDefault()` + deferred `setSelection()` via `setTimeout(0)`.
- The `setTimeout(0)` is essential — `setSelection` during mousedown processing doesn't reliably dispatch CustomEvents that Vaadin's @DomEvent listeners receive.

### `_dialogJustClosed` Pattern
- After dialog close, cursor position at `index + 1` makes `selectedPlaceholder` detect the just-inserted placeholder.
- Flag set in `_closePlaceholderDialog()`, cleared on editor mousedown, consumed in `_onPlaceholderClick()`.

### Ctrl+P Browser Interception
- Chromium intercepts Ctrl+P at browser level → test uses synthetic KeyboardEvent dispatch to editor root.
