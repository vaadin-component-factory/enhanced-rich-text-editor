# Phase 3.4a: Placeholder Button Active State Fix

## Status: COMPLETE

## Description

Fix the placeholder toolbar button to correctly show "active" state when the cursor is positioned beside a placeholder in the editor (via mouse or keyboard navigation).

## Problem

Currently the placeholder button stays "inactive" even when the cursor is adjacent to a placeholder. The event log shows `PlaceholderLeave` firing immediately, even when the cursor is still positioned at the placeholder.

## Root Cause Hypothesis

Quill 2's guard elements (zero-width text nodes `\uFEFF` inside the embed) likely interfere with the "beside placeholder" detection. The cursor might technically be inside a guard node rather than "at" the embed index from Quill's perspective.

## Expected Behavior

The placeholder button should be marked as "active" (matching RTE 2's toolbar button active state styling) when:
- Cursor is placed immediately before the placeholder (index = embed index)
- Cursor is placed immediately after the placeholder (index = embed index + 1)
- User clicks on the placeholder (triggering placeholder dialog)

The button should return to "inactive" state when the cursor moves to a position that is not adjacent to any placeholder.

## Implementation Notes

- Check `_onSelectionChange()` logic for placeholder detection
- May need to use `Quill.getLeaf()` or `Quill.getLine()` to accurately detect adjacent embeds despite guard nodes
- Consider comparing with RTE 2's link button active state detection as reference
- Event sequence: selection-change → check bounds → update button state

## Acceptance Criteria

- [ ] Placeholder button shows active state when cursor is before placeholder
- [ ] Placeholder button shows active state when cursor is after placeholder
- [ ] Placeholder button shows active state when placeholder is clicked
- [ ] Button returns to inactive when cursor moves away
- [ ] No console errors
- [ ] Behavior matches stock RTE 2's link button active state pattern

## Test Impact

No new tests needed — existing placeholder tests should pass. May need to add explicit test for button active state if not already covered.

## Implementation (2026-02-20)

### Changes Made

Modified `_getSelectedPlaceholders(range)` method in `vcf-enhanced-rich-text-editor.js` (lines 1498-1512):

**Before:** Only checked `range.index - 1` for cursor positions, missing placeholders when cursor was before the embed or inside guard nodes.

**After:** For zero-length selections (cursor position), now checks BOTH:
- `range.index - 1` (cursor after placeholder)
- `range.index` (cursor before/at placeholder)

This handles Quill 2's Embed guard nodes which can create ambiguous cursor positions. Added deduplication logic to avoid returning the same placeholder twice if detected at both positions.

### Root Cause Confirmed

The issue was exactly as hypothesized: Quill 2's Embed blots have guard nodes (`\uFEFF`) flanking the content node, creating multiple valid cursor positions adjacent to a single embed. The single-position check missed cases where the cursor was positioned before the placeholder or inside the left guard node.

### Test Results

All 30 placeholder tests pass (2 skipped as expected - copy-paste and undo-remove, known Quill 2 limitations):
```
✓ 30 passed (52.7s)
- 2 skipped
```

### Acceptance Criteria Status

- [x] Placeholder button shows active state when cursor is before placeholder
- [x] Placeholder button shows active state when cursor is after placeholder
- [x] Placeholder button shows active state when placeholder is clicked
- [x] Button returns to inactive when cursor moves away
- [x] No console errors
- [x] Behavior matches stock RTE 2's link button active state pattern

### Files Modified

- `/workspace/enhanced-rich-text-editor-v25/src/main/resources/META-INF/resources/frontend/vcf-enhanced-rich-text-editor.js` - Lines 1498-1544 (method replaced)

### Performance Impact

Minimal - adds one extra `getContents(index, 1)` call for cursor positions (range selections unchanged). This is acceptable for a bug fix that makes the feature work correctly.
