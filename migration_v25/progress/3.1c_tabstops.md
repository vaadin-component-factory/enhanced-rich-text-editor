# Phase 3.1c: Tabstops + Rulers + Soft-Break (Features 1, 2, 3)

## Status: COMPLETE

## Feature Summary
Tab key inserts TabBlot embed. Tab width calculated iteratively from defined tabstop positions.
L/R/M alignment. Horizontal ruler with clickable tabstop markers. Soft-break (Shift+Enter)
copies tabs up to cursor position. Java API: `TabStop` class, `setTabStops()`, `setNoRulers()`.

## Dependencies
- Phase 3.1a (Custom Slots) — toolbar infrastructure
- Phase 3.1b (Readonly) — sanitizer infrastructure (class whitelist)

## Implementation Summary

### JS (`vcf-enhanced-rich-text-editor.js`)
- **TabBlot**: Quill 2 Embed, `<span class="ql-tab">`, mousedown handler for smart cursor placement
- **SoftBreakBlot**: Quill 2 Embed, `<br>` content element
- **Tab width engine**: 9 methods ported from V24 (`_updateTabWidths`, `_requestTabUpdate`, `_measureContentWidth`, etc.)
- **Keyboard bindings**: Tab (insert + sync setSelection), Shift+Enter (soft-break with tab copying limited by tabstop count), Shift+Tab (focus toolbar), Enter (tab update passthrough)
- **Ruler DOM**: `_injectRuler()` creates ruler with direction-based tabstop icons, click to add, click marker to cycle L→R→M→remove
- **CSS**: `.ql-tab` (inline-block, GPU-optimized), `.ql-soft-break` (inline), ruler styles
- **Properties**: `tabStops` (Array), `noRulers` (Boolean, reflect)

### Java
- **`TabStop.java`**: Immutable value object with `Direction` enum (LEFT, RIGHT, MIDDLE)
- **`EnhancedRichTextEditor.java`**: `setTabStops()`, `getTabStops()`, `setNoRulers()`, `isNoRulers()` using Jackson 3
- **`RteExtensionBase.java`**: Sanitizer updated with `ql-tab`, `ql-soft-break` in ALLOWED_ERTE_CLASSES
- **`ErteTabStopTestView.java`**: Route `erte-test/tabstops`, 3 tabstops (L@150, R@350, M@550)

### Test Results
- **64 passed**, 11 skipped (9 whitespace indicators → Phase 3.3b, 2 formatted text → Quill 2 limitation)
- Regression: readonly 17 pass + 1 fixme, toolbar 19 pass + 5 future

## Key Learnings
1. **Embed outer node must NOT have `contenteditable="false"`** — Quill 2 guard nodes (`\uFEFF`) are INSIDE the embed domNode. Setting contenteditable on outer node makes guard nodes non-editable, breaking cursor placement.
2. **setSelection after insertEmbed must be SYNCHRONOUS with `Quill.sources.USER`** — `Promise.resolve()` + API/SILENT leaves cursor in guard node context.
3. **Ruler injection must happen BEFORE property observers** — otherwise initial tabstop rendering finds no ruler DOM.
4. **Format toggles (Ctrl+B/I) don't work at embed boundary** — Quill 2 guard-node limitation, not ERTE bug. Marked as fixme.

## Acceptance Criteria
- [x] TabBlot registered (Embed, `<span class="ql-tab">`)
- [x] Tab key inserts tab at cursor position
- [x] Iterative width calculation engine ported (~200 lines)
- [x] L/R/M alignment support
- [x] Java `TabStop` class + `setTabStops()`/`getTabStops()` API
- [x] Guard nodes handled (measure OUTER .ql-tab rect)
- [x] SoftBreakBlot registered (Embed, `<span class="ql-soft-break"><br></span>`)
- [x] Shift+Enter copies tabs up to cursor position (limited by tabstop count)
- [x] Horizontal ruler with clickable tabstop markers
- [x] `setNoRulers()` / `isNoRulers()` API
- [x] Playwright tests: 64 pass, 11 fixme
- [x] Sanitizer updated for ql-tab, ql-soft-break classes
