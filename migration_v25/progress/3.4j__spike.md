# Phase 3.4j Spike: Aura Style Proxy Prototype

**Status:** NOT STARTED
**Type:** Technical Spike / Proof of Concept
**Priority:** HIGH — Prerequisite for Phase 3.4j implementation
**Created:** 2026-02-21

---

## Objective

Prototype the Aura Style Proxy mechanism to verify technical feasibility before full implementation in Phase 3.4j. Validate that:
1. Runtime stylesheet scanning works reliably
2. Rule cloning and selector replacement functions correctly
3. Performance impact is acceptable
4. Edge cases (CORS, timing, duplicates) are handled properly
5. The approach works with both Lumo and Aura themes

---

## Scope

**Build a minimal working prototype** that demonstrates:
- Scanning document stylesheets for RTE rules
- Cloning rules with ERTE tag name
- Injecting cloned rules into document
- Testing with actual Aura theme in demo app

**Out of scope for spike:**
- Token replacement (`--lumo-*` → `--vaadin-*`) — straightforward, no spike needed
- Production-ready error handling
- Complete documentation

---

## Implementation Steps

### Step 1: Create Spike Test View

Create a dedicated test view in the demo app for spike testing.

**File:** `enhanced-rich-text-editor-demo/src/main/java/com/vaadin/componentfactory/ErteAuraSpikeView.java`

```java
package com.vaadin.componentfactory;

import com.vaadin.flow.component.html.Div;
import com.vaadin.flow.component.html.H2;
import com.vaadin.flow.component.html.Paragraph;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.router.Route;

/**
 * Spike test view for Aura Style Proxy prototype.
 * Tests runtime stylesheet scanning and rule injection.
 */
@Route("erte-spike/aura-proxy")
public class ErteAuraSpikeView extends VerticalLayout {
    public ErteAuraSpikeView() {
        add(new H2("Aura Style Proxy Spike"));
        add(new Paragraph("Testing runtime stylesheet scanning and rule cloning."));

        // Stock RTE (receives Aura styles normally)
        var stockRte = new com.vaadin.flow.component.richtexteditor.RichTextEditor();
        stockRte.setId("stock-rte");
        stockRte.setWidthFull();

        // ERTE (should receive cloned Aura styles via proxy)
        var erteRte = new EnhancedRichTextEditor();
        erteRte.setId("erte-rte");
        erteRte.setWidthFull();

        add(new H2("Stock RTE (vaadin-rich-text-editor)"), stockRte);
        add(new H2("ERTE (vcf-enhanced-rich-text-editor)"), erteRte);

        // Debug output div
        Div debugOutput = new Div();
        debugOutput.setId("debug-output");
        debugOutput.getStyle()
            .set("margin-top", "2em")
            .set("padding", "1em")
            .set("border", "1px solid var(--lumo-contrast-20pct)")
            .set("background", "var(--lumo-contrast-5pct)");
        add(new H2("Debug Output"), debugOutput);
    }
}
```

### Step 2: Add Spike Proxy Method to ERTE

Add prototype `_injectAuraStyleProxy()` to ERTE's JS file.

**File:** `enhanced-rich-text-editor-v25/src/main/resources/META-INF/resources/frontend/vcf-enhanced-rich-text-editor.js`

**Location:** After `ready()` method, before `_applyErteI18n()`

```javascript
/**
 * SPIKE: Aura Style Proxy prototype.
 * Scans document stylesheets and clones RTE rules for ERTE.
 * @private
 */
_injectAuraStyleProxySpike() {
  console.group('ERTE Spike: Aura Style Proxy');

  // Guard: avoid duplicate injection
  if (document.querySelector('style[data-vcf-erte-spike-proxy]')) {
    console.log('Proxy already injected, skipping.');
    console.groupEnd();
    return;
  }

  const startTime = performance.now();
  const stats = {
    totalSheets: 0,
    scannedSheets: 0,
    corsSkipped: 0,
    totalRules: 0,
    matchedRules: 0,
  };

  const rteRules = [];

  // Scan all stylesheets
  for (const sheet of document.styleSheets) {
    stats.totalSheets++;

    try {
      stats.scannedSheets++;
      const rules = Array.from(sheet.cssRules || []);
      stats.totalRules += rules.length;

      for (const rule of rules) {
        if (rule.cssText && rule.cssText.includes('vaadin-rich-text-editor')) {
          rteRules.push({
            original: rule.cssText,
            sheet: sheet.href || '(inline)',
          });
          stats.matchedRules++;
        }
      }
    } catch (e) {
      // CORS-protected sheet
      stats.corsSkipped++;
      console.warn('Skipped stylesheet (CORS):', sheet.href, e.message);
    }
  }

  if (rteRules.length === 0) {
    console.log('No RTE-specific rules found.');
    console.groupEnd();
    return;
  }

  // Clone rules with ERTE tag
  const proxyStyles = rteRules.map(({ original }) =>
    original.replace(/vaadin-rich-text-editor/g, 'vcf-enhanced-rich-text-editor')
  );

  // Inject into document
  const styleEl = document.createElement('style');
  styleEl.setAttribute('data-vcf-erte-spike-proxy', '');
  styleEl.textContent = [
    '/* ERTE Aura Style Proxy (SPIKE) */',
    `/* Generated: ${new Date().toISOString()} */`,
    `/* Cloned ${stats.matchedRules} rules */`,
    '',
    ...proxyStyles,
  ].join('\n');
  document.head.appendChild(styleEl);

  const endTime = performance.now();
  const duration = (endTime - startTime).toFixed(2);

  // Log stats
  console.table(stats);
  console.log(`Duration: ${duration}ms`);
  console.log('Sample cloned rules:', proxyStyles.slice(0, 3));
  console.log('Full injected stylesheet:', styleEl.textContent.substring(0, 500) + '...');
  console.groupEnd();

  // Write debug output to page
  this._writeSpikeDebugOutput(stats, duration, rteRules.length);
}

/**
 * Writes spike debug output to the page (if debug div exists).
 * @private
 */
_writeSpikeDebugOutput(stats, duration, clonedCount) {
  const debugDiv = document.getElementById('debug-output');
  if (!debugDiv) return;

  debugDiv.innerHTML = `
    <h3>Spike Results</h3>
    <ul>
      <li><strong>Total Stylesheets:</strong> ${stats.totalSheets}</li>
      <li><strong>Scanned:</strong> ${stats.scannedSheets}</li>
      <li><strong>CORS Skipped:</strong> ${stats.corsSkipped}</li>
      <li><strong>Total Rules:</strong> ${stats.totalRules}</li>
      <li><strong>Matched RTE Rules:</strong> ${stats.matchedRules}</li>
      <li><strong>Cloned Rules:</strong> ${clonedCount}</li>
      <li><strong>Duration:</strong> ${duration}ms</li>
    </ul>
    <p><em>Check browser console for full details.</em></p>
  `;
}
```

**Call from `ready()`:**
```javascript
ready() {
  super.ready();

  // ... existing ready() code ...

  // SPIKE: Test Aura Style Proxy
  this._injectAuraStyleProxySpike();
}
```

### Step 3: Configure Demo with Aura Theme

**Option A: Application-wide Aura** (simplest for spike)

**File:** `enhanced-rich-text-editor-demo/src/main/java/com/vaadin/componentfactory/Application.java`

```java
@Theme(value = "aura")  // Change from "lumo" to "aura"
public class Application implements AppShellConfigurator {
    // ...
}
```

**Option B: Per-route Aura** (if keeping Lumo for other views)

Use `@Theme` annotation on `ErteAuraSpikeView`:
```java
@Route("erte-spike/aura-proxy")
@Theme("aura")
public class ErteAuraSpikeView extends VerticalLayout {
    // ...
}
```

### Step 4: Build and Test

```bash
# Build ERTE module
bash v25-build.sh

# Start demo
bash v25-server-start.sh

# Navigate to: http://localhost:8080/erte-spike/aura-proxy
```

---

## Validation Criteria

### 1. **Functional Test**

Open spike view in browser and verify:
- ✅ Stock RTE appears with Aura styling (Aura toolbar colors/spacing)
- ✅ ERTE appears with **matching** Aura styling (via proxy)
- ✅ No JavaScript errors in console
- ✅ Console log shows proxy stats (rules found, duration)
- ✅ Debug output on page shows reasonable stats

**Expected stats:**
- Total Stylesheets: 5-10 (Vaadin, Lumo/Aura, app styles)
- Scanned: 5-10 (same, unless CORS)
- CORS Skipped: 0 (in local dev)
- Total Rules: 500-2000 (depends on theme)
- Matched RTE Rules: 10-30 (Aura's RTE-specific rules)
- Cloned Rules: Same as matched
- Duration: <10ms

### 2. **Visual Comparison**

Compare Stock RTE and ERTE side-by-side:
- Toolbar button colors → Should match
- Toolbar spacing/padding → Should match
- Icon styles → Should match
- Part borders/shadows → Should match

### 3. **Performance Test**

- ✅ Duration < 20ms (acceptable cold start)
- ✅ No visible delay when loading page
- ✅ Single injection only (guard works)

### 4. **Edge Case Tests**

**Test A: Reload page**
- Proxy should inject again (previous injection is lost)
- Stats should be consistent

**Test B: Multiple ERTE instances**
- Add second ERTE to spike view
- Proxy should inject only once (guard prevents duplicates)

**Test C: Switch back to Lumo**
- Change `@Theme` to "lumo"
- Rebuild, restart
- ERTE should still work (Lumo via lumoInjector, proxy finds no Aura rules)

---

## Success Criteria

- ✅ Prototype code implemented
- ✅ Spike view functional
- ✅ Visual comparison: ERTE matches Stock RTE under Aura
- ✅ Performance: Duration < 20ms
- ✅ Edge cases tested (reload, multiple instances, Lumo)
- ✅ No CORS errors in local dev
- ✅ Approach validated as feasible

---

## Risks & Mitigations

| Risk | Likelihood | Mitigation |
|------|-----------|------------|
| Rules not found (timing) | Low | Test with `requestAnimationFrame()` delay if needed |
| CORS issues | Low | Test with external CDN stylesheet if possible |
| Performance too slow | Very Low | 5-10ms expected, acceptable up to 50ms |
| Cloned rules don't apply | Low | Verify specificity, use `!important` if needed (spike only) |
| Multiple injections | Low | Guard with data attribute (already in code) |

---

## Next Steps After Spike

**If successful:**
1. Clean up prototype code (remove debug logging, extract to dedicated method)
2. Proceed with Phase 3.4j implementation
3. Add production error handling
4. Add comprehensive documentation

**If issues found:**
1. Document the issue in spike report
2. Adjust approach (e.g., mutation observer for timing, specificity boost for cloned rules)
3. Re-run spike with adjusted implementation
4. Update Phase 3.4j plan based on findings

---

## Spike Report Template

After completing spike, document findings in this section:

### Results

- **Visual Test:** ✅/❌ ERTE matches Stock RTE under Aura
- **Performance:** X.XX ms (target: <20ms)
- **Stats:**
  - Total Stylesheets: X
  - Matched RTE Rules: X
  - CORS Issues: Yes/No
- **Edge Cases:** All pass / Issues found (describe)

### Issues Encountered

(List any problems, workarounds, or unexpected behavior)

### Recommendations

(Should we proceed with Phase 3.4j as planned? Any adjustments needed?)

---

## Estimated Effort

**Total: 2-3 hours**
- Test view setup: 30 minutes
- Prototype implementation: 1 hour
- Testing (functional, performance, edge cases): 1 hour
- Documentation: 30 minutes

---

## Dependencies

- Vaadin 25 demo app with Aura theme configured
- Enhanced Rich Text Editor V25 module built
- Browser with dev tools (Chrome/Firefox/Safari)
