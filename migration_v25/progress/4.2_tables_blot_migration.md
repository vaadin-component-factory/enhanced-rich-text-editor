# Phase 4.2: Tables Blot Migration

**Status:** COMPLETE

## What Was Done

### JS Files Created (6 new files)

All in `enhanced-rich-text-editor-tables/src/main/resources/META-INF/frontend/src/erte-table/js/`:

1. **utils.js** — `randomId()`, `getQuill(el)` via `Quill.find()`, `HIDDEN_BORDER_CLASS` constant
2. **ContainBlot.js** — Base container blot, extends `Container`, `formats()` returns `{}`
3. **TableCellBlot.js** — `<td>` blot, `className='td-q'`, pipe-separated metadata, `checkMerge()` by `cell_id`, orphan-TD wrapping
4. **TableRowBlot.js** — `<tr>` blot, circular dep resolved via `setTableCellClass()`, `checkMerge()` by `row_id`
5. **TableBlot.js** — `<table>` blot, `defaultChild=TableRow`, colgroup creation, hidden merged cells
6. **TableModule.js** — Functional module (not Quill Module class), clipboard matchers (TABLE/TR/TD), keyboard bindings (Tab/Shift+Tab cell navigation, stubs for Backspace/Delete/Ctrl+A)

### Connector Rewritten

`connector.js` — Fixed Phase 4.1 bug (wrong hook namespace). Now uses correct `window.Vaadin.Flow.vcfEnhancedRichTextEditor.extendQuill/extendEditor`. Guard against double registration via `Quill.__tablesRegistered`.

### Sanitizer Updated

- **Client (JS):** Added `'ql-editor__table--hideBorder'` to `ERTE_PRESERVED_CLASSES`
- **Server (Java):** Added `td-q`, `ql-editor__table--hideBorder` to `ALLOWED_ERTE_CLASSES`. Added `table`, `tbody`, `tr`, `td`, `th`, `colgroup`, `col` tags. Added `table_id`, `row_id`, `cell_id`, `merge_id`, `colspan`, `rowspan`, `table-class` attributes.

### Test View Updated

- `ErteTablesTestView.java` — Added TextArea for Delta JSON input + "Load Delta" / "Read Delta" buttons for manual testing

### Sample Delta Files

- `sample-delta-2x2.json` — Simple 2x2 table (empty cells)
- `sample-delta-2tables.json` — Two separate tables with text in cells

## Verification Results (2026-02-23)

### All Tests PASS:

- [x] **Empty 2x2 table**: Delta insertion creates correct DOM: `<table table_id="tbl1">` → 2 `<tr>` → 2 `<td class="td-q">` each, all IDs correct
- [x] **Delta round-trip**: `setContents()` → `getContents()` returns identical td attributes
- [x] **Server round-trip**: Table structure survives blur → server sanitizer → `dangerouslySetHtmlValue` cycle. All IDs, classes, text preserved
- [x] **Two tables with text**: 2 separate tables (tblA: 2x2 with text, tblB: 1x2 with text), `<p>Text between tables</p>` separating them — all IDs and text correct
- [x] **Two tables server round-trip**: Both tables + text survive 3-second server roundtrip without corruption
- [x] **Tab navigation**: Tab moves cursor c1→c2→c3 (crosses row boundary), Shift+Tab moves back c3→c2
- [x] **Colgroup**: Created automatically with correct number of `<col>` elements
- [x] **No JS errors**: Zero console errors in all tests
- [x] **Regression tests**: 213 passed, 1 failed (pre-existing shell test), 10 skipped (known fixme)

### Regression Test Detail

```
ERTE regression: 213 passed, 1 failed, 10 skipped (1.5m)
Failed: erte-shell.spec.ts — "Delta accessible via Quill getContents()"
  (pre-existing failure, not table-related — expects "ERTE V25" text in demo view)
```

## Key Bug Fixes During Verification

### 1. Infinite Loop in optimize() (CRITICAL)
**Problem:** Page froze with 202,652+ merge iterations in Table.optimize()
**Root cause:** Missing `next.prev === this` safety check + TableRow calling `super.optimize()` caused Container.checkMerge to trigger double-merge
**Fix:** Rewrote all 4 blot files based on v25-old working patterns:
- ContainBlot: Removed optimize() override entirely
- TableRow: Does NOT call super.optimize() — manual empty-child handling + merge loop
- Table/Cell: Merge loops have `next.prev === this` + `tagName` safety checks

### 2. TypeError: value.split is not a function
**Problem:** `dangerouslySetHtmlValue` round-trip causes Parchment auto-wrapping, passes non-string values to create()
**Fix:** Added `typeof value === 'string'` type guards in all 3 `create()` methods, fallback to `randomId()`

### 3. TR Consolidation After Table Merge
**Problem:** Parchment 3 bottom-up optimize runs TDs → TRs → Tables. After table merge, TRs become siblings but aren't re-optimized
**Fix:** Added TR consolidation loop in Table.optimize() after table merge

### 4. `class="false"` on `<table>` Element (Clipboard Matcher Bug)
**Problem:** Table element got `class="false"` after Java `asDelta().setValue()` round-trip. The 7th field of TD pipe-string contained boolean `false` instead of empty string.
**Root cause:** `TableModule.js` clipboard TD matcher used `tableNode.classList.contains(HIDDEN_BORDER_CLASS)` (returns boolean) directly in the pipe array. `false.toString()` → `"false"` → set as `table-class` attribute → passed to `Table.create()` → `classList.add("false")`.
**Fix:** Changed to `tableNode && tableNode.classList.contains(HIDDEN_BORDER_CLASS) ? HIDDEN_BORDER_CLASS : ''`. Also fixed `getAttribute()` null-to-"null" issue in `TableCellBlot.formats()` by adding `|| ''` fallbacks.
**HTML Output also fixed:** With the class="false" fix, the `asDelta().setValue()` → server round-trip → `dangerouslySetHtmlValue()` cycle now correctly preserves table HTML including `<table>`, `<tr>`, `<td>` tags in both the editor DOM and the HTML value output.

## Parchment 3 Changes Applied

| # | Change | Implementation |
|---|--------|---------------|
| 1 | `Parchment.create()` removed | `this.scroll.create(name, val)` everywhere |
| 2 | `defaultChild` is class ref | `TableRow.defaultChild = Block` → set to `TableCell` via `setTableCellClass()` |
| 3 | `checkMerge()` required | Override in all 3 container blots, check by ID attribute |
| 4 | While merge loops | `optimize()` uses `while` loop with `next.prev === this` safety |
| 5 | `formats()` returns `{}` | Not tagName string (prevents char-spread bug) |
| 6 | `create()` type guards | All 3 create() methods handle non-string values from auto-wrapping |

## Key Design Decisions

- **Based on v25-old working implementation** — proven patterns from first migration attempt
- **Functional module** instead of Quill Module class (editor already created when `extendEditor` fires)
- **Circular dependency** TableRow ↔ TableCell resolved via deferred `setTableCellClass()` setter
- **Container.order** set before registration: `['list', 'contain', 'td', 'tr', 'table']`
- **Tab/Shift+Tab** prepended before ERTE tabstop handler (tables take priority when cursor is in table)
- **TableRow skips super.optimize()** — avoids enforceAllowedChildren conflict with manual child management
- **Template-based sanitizer** deferred to Phase 4.3 (current sanitizer allows table structure but not dynamic template classes)

## Visual Note

Tables render without visible borders (no CSS applied yet). Table CSS is Phase 4.3 scope (requires TableTrick + template-based styling). Data structure and functionality verified correct.
