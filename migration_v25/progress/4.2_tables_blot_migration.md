# Phase 4.2: Tables Blot Migration

**Status:** NOT STARTED

## Objective

Migrate all table blots from Quill 1 / Parchment 2 to Quill 2 / Parchment 3, applying breaking changes and integrating with ERTE 2.

## Scope

### Blots to Migrate (5 total)

1. **TableContainer** (Block)
   - Top-level table wrapper
   - Manage table lifecycle
   - Handle table-level operations

2. **Table** (Block)
   - `<table>` element
   - Cell metadata encoding/decoding
   - Table ID management

3. **TableBody** (Block)
   - `<tbody>` element
   - Row container
   - Body-level operations

4. **TableRow** (Block)
   - `<tr>` element
   - Row ID management
   - Row operations (add/delete)

5. **TableCell** (Block)
   - `<td>` element
   - Cell metadata: rowspan, colspan, templateId, uniqueId
   - Cell format: `{tableId}|{rowId}|{cellId}|{rowspan}|{colspan}|{templateId}|{uniqueId}`

### Parchment 3 Breaking Changes (from SPIKE_RESULTS.md)

All 5 critical changes must be applied:

1. **`domNode` → `this.domNode`** in all methods
2. **`children` → `this.children`** for child access
3. **`statics` → `static`** class fields
4. **Remove `super.formats()`** — Parchment 3 throws error
5. **`allowedChildren` removed** — implement `insertBefore()` validation instead

### Additional V25 Changes

- Guard node awareness (Quill 2 embeds)
- Sanitizer integration (whitelist table elements/attributes)
- Quill 2 lifecycle hooks
- Delta format compatibility

## Success Criteria

- [ ] All 5 blots migrated to Parchment 3
- [ ] Table insertion works
- [ ] Cell metadata preserved
- [ ] Row/column operations functional
- [ ] Sanitizer allows table markup
- [ ] No console errors
- [ ] Reviewed by fullstack-developer agent

## Technical Challenges

**Cell Metadata Format:**
```
{tableId}|{rowId}|{cellId}|{rowspan}|{colspan}|{templateId}|{uniqueId}
```
- Must survive HTML→Delta→HTML roundtrip
- Sanitizer must preserve `data-*` attributes
- Delta ops must encode/decode correctly

**Nested Block Structure:**
```
TableContainer > Table > TableBody > TableRow > TableCell > content
```
- Parchment 3 `insertBefore()` validation needed
- Child constraints enforcement
- Delete propagation

## Resources

- V24 table blots (`enhanced-rich-text-editor-tables/src/main/resources/META-INF/resources/frontend/`)
- `SPIKE_RESULTS.md` — Parchment 3 breaking changes
- V25 TabBlot, PlaceholderBlot — reference implementations
- Quill 2 / Parchment 3 docs (via WebSearch/WebFetch)

## Output

- `frontend/table-container-blot.js`
- `frontend/table-blot.js`
- `frontend/table-body-blot.js`
- `frontend/table-row-blot.js`
- `frontend/table-cell-blot.js`
- Quill.register() calls in main module
