# Phase 3.4c: Whitespace Indicators for Spaces and NBSP

## Status: COMPLETE (NBSP ONLY)

## Description

Extend the whitespace indicators feature (Phase 3.3b) to show indicators for non-breaking spaces (NBSP). Regular spaces are intentionally deferred (see rationale below).

## Problem

Phase 3.3b implemented whitespace indicators but did not include:
- Regular spaces (U+0020)
- Non-breaking spaces (U+00A0, inserted via Shift+Space in Phase 3.3a)

Both should display a middle dot `·` (U+00B7) when whitespace indicators are enabled.

## Design

- **Visual**: Middle dot `·` in light gray (matching tab/paragraph indicator style)
- **Toggle**: Controlled by existing `whitespaceIndicatorsVisible` property
- **CSS**: Add to existing `.ql-show-whitespace` ruleset in `vcf-enhanced-rich-text-editor.js`
- **NBSP**: Target the `<span class="ql-nbsp">` embed (Phase 3.3a)
- **Spaces**: Use CSS `::before` pseudo-element on text nodes (tricky — may need different approach)

## Implementation Challenges

### Regular Spaces
Text nodes don't support `::before`/`::after` pseudo-elements in CSS. Options:
1. **Inline indicator spans**: Wrap each space in `<span class="space-indicator"> </span>` via Quill format
2. **Font substitution**: Use a custom font with visible space glyphs (not recommended — accessibility issues)
3. **Background-based**: Use `background-image` with repeated dots (limited control)
4. **JavaScript injection**: Traverse text nodes and inject indicator elements (fragile, performance concern)

**Recommended**: Option 1 (inline spans) via custom Inline blot or format, similar to readonly formatting.

### NBSP Embed
NBSP is already wrapped in `<span class="ql-nbsp">` — add `::before` indicator in CSS when `.ql-show-whitespace` is active. **This is straightforward.**

## Implementation Approach

1. **NBSP first** (easy win):
   - Add CSS rule: `.ql-show-whitespace .ql-nbsp::before { content: '·'; color: ...; }`
   - Test with existing NBSP tests

2. **Regular spaces** (complex):
   - Evaluate options 1–4 above
   - If using inline spans: create `SpaceIndicatorBlot` or `space` format
   - Apply format when whitespace indicators toggle on
   - Remove format when toggle off
   - Consider performance impact (many spaces in large documents)

3. **Alternative**: Skip regular spaces if implementation is too fragile/complex. Focus on NBSP only as a pragmatic compromise.

## Acceptance Criteria

- [ ] NBSP shows middle dot `·` when whitespace indicators enabled
- [ ] Regular spaces show middle dot `·` when whitespace indicators enabled (if feasible)
- [ ] Indicators disappear when whitespace indicators disabled
- [ ] No performance degradation on large documents
- [ ] No visual artifacts or layout shifts
- [ ] Indicators match existing tab/paragraph style (light gray, middle dot)
- [ ] Tests pass (update `features.spec.ts` whitespace tests)

## Test Impact

Extend existing whitespace indicator tests in `features.spec.ts` to verify:
- NBSP indicator appears/disappears with toggle
- Space indicator appears/disappears with toggle (if implemented)
- No side effects on formatting or editing

## Cross-Cutting Notes

If regular space indicators prove too complex or fragile, document the limitation and consider it a "nice-to-have" deferred to a future version. NBSP indicators alone provide significant value.

## Implementation Summary

**Decision**: Implemented NBSP indicators ONLY. Regular spaces deferred to future version.

**Rationale**:
1. **Feature parity achieved**: ERTE 1 did NOT have space indicators (only tabs, soft-breaks, paragraphs). Phase 3.3b already achieved parity.
2. **Complexity vs. value**: Regular spaces require complex format blot implementation with O(n) performance overhead, dynamic toggle handling, and clipboard concerns.
3. **NBSP is trivial**: Already wrapped in `<span class="ql-nbsp">` — simple CSS addition.
4. **Migration priority**: Focus on completing core features → documentation → tables. This is Phase 3.4 "Open Issues" (fixing gaps), not adding complex new features.

**What was implemented**:
- CSS rule targeting `.show-whitespace span.ql-nbsp::before` with middle dot (·)
- Styling matches tab/soft-break indicators (light gray, `--lumo-contrast-40pct`)
- 3 new Playwright tests in `features.spec.ts`:
  1. NBSP shows middle dot when indicators enabled
  2. NBSP indicator disappears when indicators disabled
  3. Multiple NBSPs show individual indicators

**Files modified**:
- `vcf-enhanced-rich-text-editor.js`: +8 lines CSS @ line 561
- `features.spec.ts`: +88 lines tests @ line 97
- `TEST_INVENTORY.md`: +3 test entries
- `STATUS.md`: Phase 3.4c marked COMPLETE

**Test results**: 3 new tests pass, no regressions.

## Known Limitations

**Regular spaces (U+0020) do NOT show indicators.** This is consistent with ERTE 1 behavior and not a regression.

Users who need space visibility should use NBSP (Shift+Space), which shows a middle dot indicator when whitespace indicators are enabled.

**Future enhancement**: If space indicators are requested post-migration, investigate:
- Shadow DOM decoration APIs (if available)
- Quill rendering hooks (avoiding format blot performance overhead)
- Browser-native whitespace visualization features

Do NOT implement as format blot — O(n) format application on every toggle creates unacceptable performance impact for large documents.
