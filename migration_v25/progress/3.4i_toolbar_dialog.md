# Phase 3.4i: ToolbarDialog

**Status:** NOT STARTED
**Type:** Feature Migration
**Priority:** MEDIUM — Helper class for custom toolbar extensions
**Created:** 2026-02-21

---

## Scope

Migrate `ToolbarDialog` class from V24 to V25. This is a convenience wrapper around Vaadin's `Dialog` component that integrates with `ToolbarSwitch` for opening/closing, with optional positioning at the switch.

---

## Background

### V24 Implementation

Location: `enhanced-rich-text-editor/src/main/java/com/vaadin/componentfactory/toolbar/ToolbarDialog.java`

**Key Features:**
- Wraps Vaadin 24's `Dialog` component
- Opens/closes based on `ToolbarSwitch` active state
- Optional positioning: opens aligned to the switch button (via `openAtSwitch()`)
- Provides static factory methods: `vertical()` and `horizontal()`
- Automatic focus management (`setFocusOnOpenTarget()`)
- Default settings: non-modal, resizable, draggable, no padding, close on ESC
- Uses JS to position dialog overlay at switch location

**API:**
```java
// Factory methods
static ToolbarDialog vertical(ToolbarSwitch toolbarSwitch, Component... components)
static ToolbarDialog horizontal(ToolbarSwitch toolbarSwitch, Component... components)
static ToolbarDialog horizontal(ToolbarSwitch toolbarSwitch, Alignment alignment, Component... components)

// Constructors
ToolbarDialog(ToolbarSwitch toolbarSwitch)
ToolbarDialog(ToolbarSwitch toolbarSwitch, boolean openAtSwitch)

// Methods
void setFocusOnOpenTarget(Component focusOnOpenTarget)
ToolbarSwitch getToolbarSwitch()
ToolbarDialog openAtSwitch()
```

**Positioning Logic (V24):**
```java
getElement().executeJs("""
    const {left, top, width, height} = $0.getBoundingClientRect();
    this.$.overlay.$.overlay.style.position = 'absolute';
    this.$.overlay.$.overlay.style.left = left + 'px';
    this.$.overlay.$.overlay.style.top = top + height + 'px';""",
    getToolbarSwitch());
```

### V25 Changes

**Vaadin 25 Dialog API:**
- Check if `Dialog` API changed between V24 and V25
- **CRITICAL:** Verify overlay DOM structure (`this.$.overlay.$.overlay`) — Vaadin moved from Polymer to Lit, so this may have changed
- Confirm `setCloseOnOutsideClick()`, `setCloseOnEsc()`, `setModal()`, `setResizable()`, `setDraggable()` unchanged
- Verify `DialogVariant.LUMO_NO_PADDING` still exists

---

## Tasks

### 1. Investigate V25 Dialog Overlay Structure

- [ ] Create test dialog in V25 demo
- [ ] Inspect DOM structure in browser dev tools
- [ ] Identify correct selector for overlay element in V25
- [ ] Update positioning JS if needed

### 2. Create ToolbarDialog.java (V25)

Location: `enhanced-rich-text-editor-v25/src/main/java/com/vaadin/componentfactory/toolbar/ToolbarDialog.java`

- [ ] Copy V24 implementation as starting point
- [ ] Update license header (2025)
- [ ] Verify Vaadin 25 imports work (`com.vaadin.flow.component.dialog.Dialog`, `DialogVariant`)
- [ ] **Fix positioning JS** for V25 overlay structure if changed
- [ ] Test with simple example

### 3. Add JavaDoc

- [ ] Class-level JavaDoc explaining purpose
- [ ] Document integration with ToolbarSwitch
- [ ] Document positioning behavior (`openAtSwitch()`)
- [ ] Document factory methods and default settings

### 4. Create Test View (Optional)

Only if not already covered by existing demos:

- [ ] Add test view showing dialog with toolbar switch
- [ ] Test both center-positioned and switch-aligned variants
- [ ] Test vertical and horizontal layouts
- [ ] Test focus management
- [ ] Verify positioning works correctly in V25

### 5. Update Documentation

- [ ] Add to API documentation
- [ ] Add example usage in developer docs
- [ ] Mention in UPGRADE_GUIDE.md if API or positioning changed

---

## Testing Strategy

- **Manual:** Create demo with ToolbarSwitch + ToolbarDialog in both modes (center and openAtSwitch)
- **Visual:** Verify dialog appears at correct position when using `openAtSwitch()`
- **Integration:** Verify with actual ERTE instance in demo app
- **Regression:** Compare behavior with V24 implementation

---

## Dependencies

- ✅ Phase 3.1a (Toolbar Slot System) — provides `ToolbarSwitch`
- ⚠️ Phase 3.4f (Slotted Styles) — may be needed for proper button appearance

---

## Known Issues / Risks

- **Overlay Structure:** V24 used Polymer-style `this.$.overlay.$.overlay`. V25 uses Lit, so this selector may be broken.
- **Alternative:** Consider using Vaadin's `setOpener()` method if it supports positioning, or use CSS custom properties instead of JS positioning.

---

## Definition of Done

- [ ] V25 Dialog overlay structure investigated
- [ ] `ToolbarDialog.java` created with V25-compatible implementation
- [ ] Positioning logic updated for V25 if needed
- [ ] JavaDoc complete
- [ ] Manual testing shows dialog works correctly in both modes
- [ ] Focus management works as expected
- [ ] Progress file updated to COMPLETE
- [ ] Commit created: "Add ToolbarDialog helper class (Phase 3.4i)"
