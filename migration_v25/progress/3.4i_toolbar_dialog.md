# Phase 3.4i: ToolbarDialog

**Status:** COMPLETE
**Type:** Feature Migration
**Priority:** MEDIUM — Helper class for custom toolbar extensions
**Created:** 2026-02-21
**Completed:** 2026-02-21

---

## Scope

Migrate `ToolbarDialog` class from V24 to V25. This is a convenience wrapper around Vaadin's `Dialog` component that integrates with `ToolbarSwitch` for opening/closing, with optional positioning at the switch.

---

## Background

### V24 Implementation

Location: `enhanced-rich-text-editor/src/main/java/com/vaadin/componentfactory/toolbar/ToolbarDialog.java`

**Key Features:**
- Wraps Vaadin 24's `Dialog` component
- Opens/closes based on `ToolbarSwitch` active state
- Optional positioning: opens aligned to the switch button (via `openAtSwitch()`)
- Provides static factory methods: `vertical()` and `horizontal()`
- Automatic focus management (`setFocusOnOpenTarget()`)
- Default settings: non-modal, resizable, draggable, no padding, close on ESC
- Uses JS to position dialog overlay at switch location

**API:**
```java
// Factory methods
static ToolbarDialog vertical(ToolbarSwitch toolbarSwitch, Component... components)
static ToolbarDialog horizontal(ToolbarSwitch toolbarSwitch, Component... components)
static ToolbarDialog horizontal(ToolbarSwitch toolbarSwitch, Alignment alignment, Component... components)

// Constructors
ToolbarDialog(ToolbarSwitch toolbarSwitch)
ToolbarDialog(ToolbarSwitch toolbarSwitch, boolean openAtSwitch)

// Methods
void setFocusOnOpenTarget(Component focusOnOpenTarget)
ToolbarSwitch getToolbarSwitch()
ToolbarDialog openAtSwitch()
```

**Positioning Logic (V24):**
```java
getElement().executeJs("""
    const {left, top, width, height} = $0.getBoundingClientRect();
    this.$.overlay.$.overlay.style.position = 'absolute';
    this.$.overlay.$.overlay.style.left = left + 'px';
    this.$.overlay.$.overlay.style.top = top + height + 'px';""",
    getToolbarSwitch());
```

### V25 Changes

**Vaadin 25 Dialog API:**
- Check if `Dialog` API changed between V24 and V25
- **CRITICAL:** Verify overlay DOM structure (`this.$.overlay.$.overlay`) — Vaadin moved from Polymer to Lit, so this may have changed
- Confirm `setCloseOnOutsideClick()`, `setCloseOnEsc()`, `setModal()`, `setResizable()`, `setDraggable()` unchanged
- Verify `DialogVariant.LUMO_NO_PADDING` still exists

---

## Tasks

### 1. Investigate V25 Dialog Overlay Structure

- [x] Analyzed V25 web-components source (`vaadin-dialog.js`, `vaadin-dialog-overlay.js`)
- [x] Confirmed V25 structure: `<vaadin-dialog>` → `<vaadin-dialog-overlay id="overlay">` → `<div part="overlay">`
- [x] **KEY FINDING:** PolylitMixin provides `$` accessor → `this.$.overlay.$.overlay` works IDENTICALLY in V25 and V24
- [x] No changes needed to positioning JS

### 2. Create ToolbarDialog.java (V25)

Location: `enhanced-rich-text-editor-v25/src/main/java/com/vaadin/componentfactory/toolbar/ToolbarDialog.java`

- [x] Copied V24 implementation
- [x] Updated license header (2025)
- [x] Verified Vaadin 25 imports work (`com.vaadin.flow.component.dialog.Dialog`, `DialogVariant`)
- [x] **Positioning JS unchanged** - V24 code works in V25
- [x] Enhanced JavaDoc with comprehensive examples

### 3. Add JavaDoc

- [x] Class-level JavaDoc explaining purpose
- [x] Document integration with ToolbarSwitch
- [x] Document positioning behavior (`openAtSwitch()`)
- [x] Document factory methods and default settings
- [x] Added usage examples for both positioning modes

### 4. Create Test View

- [x] Created `ErteToolbarDialogTestView.java`
- [x] Test center-positioned vertical layout
- [x] Test center-positioned horizontal layout
- [x] Test positioned-at-switch variant
- [x] Test focus management
- [x] **Verified positioning works perfectly in V25** (screenshot confirms dialog appears below button)

### 5. Update Documentation

- [x] Added navigation entry in ErteTestLayout
- [ ] User documentation (deferred to Phase 3.5c)
- [ ] No upgrade guide entry needed (API 100% compatible, positioning logic unchanged)

---

## Testing Strategy

- **Manual:** Create demo with ToolbarSwitch + ToolbarDialog in both modes (center and openAtSwitch)
- **Visual:** Verify dialog appears at correct position when using `openAtSwitch()`
- **Integration:** Verify with actual ERTE instance in demo app
- **Regression:** Compare behavior with V24 implementation

---

## Dependencies

- ✅ Phase 3.1a (Toolbar Slot System) — provides `ToolbarSwitch`
- ⚠️ Phase 3.4f (Slotted Styles) — may be needed for proper button appearance

---

## Known Issues / Risks

- **Overlay Structure:** V24 used Polymer-style `this.$.overlay.$.overlay`. V25 uses Lit, so this selector may be broken.
- **Alternative:** Consider using Vaadin's `setOpener()` method if it supports positioning, or use CSS custom properties instead of JS positioning.

---

## Definition of Done

- [x] V25 Dialog overlay structure investigated
- [x] `ToolbarDialog.java` created with V25-compatible implementation
- [x] Positioning logic verified (NO changes needed!)
- [x] JavaDoc complete
- [x] Manual testing shows dialog works correctly in both modes
- [x] Focus management works as expected
- [x] Progress file updated to COMPLETE
- [x] Commit created: "Add ToolbarDialog helper class (Phase 3.4i)"

---

## Implementation Notes

### V25 Overlay Structure Investigation

**V25 DOM Structure:**
```
<vaadin-dialog>
  <vaadin-dialog-overlay id="overlay">  (Lit render)
    #shadow-root
      <div part="overlay" id="overlay">  (actual overlay container)
```

**V24 Polymer vs V25 Lit:**
- V24: `this.$.overlay.$.overlay` accessed via Polymer's `$` syntax
- V25: Uses PolylitMixin which provides SAME `$` accessor
- **Result:** `this.$.overlay.$.overlay` works IDENTICALLY in both versions

**JavaScript Positioning Code (unchanged):**
```javascript
const {left, top, width, height} = $0.getBoundingClientRect();
this.$.overlay.$.overlay.style.position = 'absolute';
this.$.overlay.$.overlay.style.left = left + 'px';
this.$.overlay.$.overlay.style.top = (top + height) + 'px';
```

### V25 Changes: NONE

**Zero code changes required** (except license header year). The V24 implementation works perfectly in V25 because:
- Dialog API unchanged (`setModal`, `setResizable`, `setDraggable`, `DialogVariant`)
- PolylitMixin provides Polymer-compatible `$` accessor
- Overlay DOM structure accessible via same path

### Manual Testing Results

**Test Cases:**
1. ✅ **Center-positioned (vertical):** Dialog centers in viewport with vertical layout
2. ✅ **Center-positioned (horizontal):** Dialog centers with horizontal layout
3. ✅ **Positioned at switch:** Dialog appears directly below toolbar button (screenshot verified)
4. ✅ **ESC key:** Closes dialog correctly
5. ✅ **State sync:** Switch active state syncs with dialog opened state
6. ✅ **Focus management:** setFocusOnOpenTarget() calls focus() on target component

**Screenshot Evidence:**
- `toolbar-dialog-positioned.png`: Shows dialog positioned below switch button
- `toolbar-dialog-center.png`: Shows center-positioned dialog with vertical layout

### Tables Addon Compatibility

**No usage in V24 Tables addon** - ToolbarDialog is provided as a utility for custom toolbar extensions but not used by Tables itself.

**Migration effort for custom extensions:** **ZERO** - Code will work as-is.
