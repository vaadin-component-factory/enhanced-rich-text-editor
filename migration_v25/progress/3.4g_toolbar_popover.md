# Phase 3.4g: ToolbarPopover

**Status:** COMPLETE
**Type:** Feature Migration
**Priority:** MEDIUM — Helper class for custom toolbar extensions
**Created:** 2026-02-21
**Completed:** 2026-02-21

---

## Scope

Migrate `ToolbarPopover` class from V24 to V25. This is a convenience wrapper around Vaadin's `Popover` component that integrates with `ToolbarSwitch` for opening/closing.

---

## Background

### V24 Implementation

Location: `enhanced-rich-text-editor/src/main/java/com/vaadin/componentfactory/toolbar/ToolbarPopover.java`

**Key Features:**
- Wraps Vaadin 24's `Popover` component
- Opens/closes based on `ToolbarSwitch` active state
- Provides static factory methods: `vertical()` and `horizontal()`
- Automatic focus management (`setFocusOnOpenTarget()`)
- Auto-attaches to switch parent, auto-detaches on switch detach
- Sets `restoreFocusOnClose` property

**API:**
```java
// Factory methods
static ToolbarPopover vertical(ToolbarSwitch toolbarSwitch, Component... components)
static ToolbarPopover horizontal(ToolbarSwitch toolbarSwitch, Component... components)
static ToolbarPopover horizontal(ToolbarSwitch toolbarSwitch, Alignment alignment, Component... components)

// Constructor
ToolbarPopover(ToolbarSwitch referencedSwitch)

// Methods
void setFocusOnOpenTarget(Component focusOnOpenTarget)
```

### V25 Changes

**Vaadin 25 Popover API:**
- Check if `Popover` API changed between V24 and V25
- Verify `restoreFocusOnClose` property still exists
- Confirm `setAutofocus()`, `setTarget()`, `addOpenedChangeListener()` unchanged

---

## Tasks

### 1. Create ToolbarPopover.java (V25)

Location: `enhanced-rich-text-editor-v25/src/main/java/com/vaadin/componentfactory/toolbar/ToolbarPopover.java`

- [x] Copy V24 implementation as starting point
- [x] Update license header (2025)
- [x] Verify Vaadin 25 imports work (`com.vaadin.flow.component.popover.Popover`)
- [x] Remove `restoreFocusOnClose` manual workaround (V25 handles internally)
- [x] Remove manual attach/detach listeners (V25 `setTarget()` handles this)
- [x] Fix focus timing in `setFocusOnOpenTarget()` by calling `setAutofocus(false)`

### 2. Add JavaDoc

- [x] Class-level JavaDoc explaining purpose with usage example
- [x] Document integration with ToolbarSwitch
- [x] Document factory methods and alignment options
- [x] Add missing `@param alignment` to three-parameter `horizontal()` method

### 3. Create Test View

- [x] Created `ErteToolbarPopoverTestView.java`
- [x] Test vertical popover (color picker)
- [x] Test horizontal popover (alignment buttons)
- [x] Test custom focus target (input field)
- [x] Event log for state changes
- [x] Control buttons for programmatic open/close
- [x] Updated `ErteTestLayout.java` navigation

### 4. Update Documentation

- [x] Progress file updated with implementation notes
- [ ] User documentation deferred to Phase 3.5c
- [x] No upgrade guide entry needed (API 100% backward compatible)

---

## Testing Strategy

- **Manual:** Create simple demo with ToolbarSwitch + ToolbarPopover, verify open/close behavior
- **Unit:** Consider unit tests for focus management and listener registration
- **Integration:** Verify with actual ERTE instance in demo app

---

## Dependencies

- ✅ Phase 3.1a (Toolbar Slot System) — provides `ToolbarSwitch`
- ⚠️ Phase 3.4f (Slotted Styles) — may be needed for proper button appearance

---

## Implementation Notes

### V25 Popover Changes

**1. `restoreFocusOnClose` removal:**
- V24 required manual property setting: `getElement().setProperty("restoreFocusOnClose", true)`
- V25 web component handles `__shouldRestoreFocus` internally via click/focus event triggers
- Manual property setting has no effect (property lives on overlay element, not popover root)
- **Solution:** Removed workaround entirely

**2. Attach/Detach listeners removal:**
- V24 required manual `addAttachListener`/`addDetachListener` to manage popover DOM attachment
- V25 `Popover.setTarget()` automatically handles attachment via internal listeners (lines 705-709 in reference source)
- Manual listeners cause double-attachment and race conditions
- **Solution:** Removed manual listeners, rely on `setTarget()` auto-management

**3. Focus timing fix:**
- Constructor calls `setAutofocus(true)` for default focus behavior
- When `setFocusOnOpenTarget()` is called with a custom target, both autofocus AND custom listener fire
- Autofocus fires later (in overlay's `__onOverlayOpened`), overwriting custom focus
- **Solution:** Call `setAutofocus(false)` at start of `setFocusOnOpenTarget()` method

### Tables Addon API Compatibility

ToolbarPopover is used by the Tables addon for the "Add Table" dimension picker. The V25 migration maintains 100% API compatibility:

- All factory methods unchanged: `vertical()`, `horizontal()` with alignment variants
- Constructor signature unchanged: `ToolbarPopover(ToolbarSwitch)`
- `setFocusOnOpenTarget()` method unchanged (only internal timing fix)
- All behavior preserved: switch/popover state sync, focus management, ESC key handling

**Impact on Phase 4 (Tables):** Zero migration effort required for ToolbarPopover usage in Tables addon.

---

## Manual Testing Results

All test cases **PASSED**:

| Test | Result |
|------|--------|
| **Open/Close Sync** | ✅ Switch active state syncs with popover opened state |
| **Programmatic Open** | ✅ `popover.setOpened(true)` activates switch |
| **Programmatic Close** | ✅ `popover.setOpened(false)` deactivates switch |
| **Focus Management** | ✅ First focusable element gets focus on open |
| **Custom Focus Target** | ✅ Specified component gets focus (verified via `document.activeElement`) |
| **ESC Key** | ✅ Popover closes, switch becomes inactive |
| **Vertical Layout** | ✅ Components stacked vertically |
| **Horizontal Layout** | ✅ Components aligned horizontally with center alignment |
| **Event Logging** | ✅ All opened/active state changes logged correctly |

**Browser:** Chromium via Playwright
**Server:** http://localhost:8080/erte-test/toolbar-popover
**Console:** 0 errors, 1 warning (React DevTools - expected)

---

## Definition of Done

- [x] `ToolbarPopover.java` created with V25-compatible implementation
- [x] JavaDoc complete with usage example
- [x] Manual testing shows open/close works correctly
- [x] Focus management works as expected
- [x] Tables addon API compatibility documented
- [x] Progress file updated to COMPLETE
- [x] Commit created: "Add ToolbarPopover helper class (Phase 3.4g)"
