# Phase 4.3b — V24 API Completeness Audit

**Status:** OPEN — findings need implementation

## Breaking Changes (must fix)

### 1. Missing `convertToCss(String)` overload
- **V24:** `public static String convertToCss(String templateJson)` — parses JSON string internally
- **V25:** MISSING — only `convertToCss(ObjectNode)` exists
- **Fix:** Add overload that parses via Jackson and delegates

### 2. Missing `parseJson(String)` methods (2 overloads)
- **V24:** `public static JsonObject parseJson(String templateJson)`
- **V24:** `public static JsonObject parseJson(String templateJson, boolean removeEmptyChildren)`
- **V25:** Both MISSING
- **Fix:** Add both with Jackson 3 equivalents (`JsonMapper.builder().build().readTree()`)

### 3. Type migration `JsonObject` → `ObjectNode` (all files)
- Affects all public/protected method signatures across 10+ files
- This is EXPECTED for the elemental.json → Jackson 3 migration
- **Not fixable** — customers must update type declarations
- **Document in upgrade guide**

### 4. Changed `getter()/setter()` signatures in RuleFormPart
- **V24:** `ValueProvider<JsonObject, String>` / `Setter<JsonObject, String>`
- **V25:** `ValueProvider<ObjectNode, String>` / `Setter<ObjectNode, String>`
- Part of the type migration (item 3). V25 setter also adds null-safety (removes empty values).

## Bug Fixes (positive changes, no action needed)

- **PATTERN_P_COLOR_2 regex fix:** V24 `[a-z\\d]` (single char) → V25 `[a-zA-Z]+` (full color names)
- **Copy template off-by-one:** V24 `substring(numberedCopyIndex, endOf)` → V25 `substring(numberedCopyIndex + 1, endOf)`
- **Array null-checks:** Added `template.has(key)` guards before casting in TemplateDialog

## New Additions (safe, no impact)

- `isValidColor()` made public in TemplateJsonConstants
- `isValidPropertyValue()`, `isValidSize()`, `isValidBorder()` — security validation
- `PATTERN_P_COLOR_5` — CSS `var(--name)` support
- Close button `setAriaLabel("Close dialog")` — accessibility

## Implementation Plan

Items 1-2 are the actionable fixes. Add these methods to `TemplateParser.java`:

```java
public static String convertToCss(String templateJson) {
    if (templateJson == null || templateJson.trim().isEmpty()) return "";
    ObjectNode parsed = (ObjectNode) JsonMapper.builder().build().readTree(templateJson);
    return convertToCss(parsed);
}

public static ObjectNode parseJson(String templateJson) {
    if (templateJson == null || templateJson.trim().isEmpty()) {
        return JsonNodeFactory.instance.objectNode();
    }
    return (ObjectNode) JsonMapper.builder().build().readTree(templateJson);
}

public static ObjectNode parseJson(String templateJson, boolean removeEmptyChildren) {
    ObjectNode object = parseJson(templateJson);
    if (removeEmptyChildren) {
        removeEmptyChildren(object);
    }
    return object;
}
```

Item 3 should be documented in the upgrade guide (Phase 4.5).
