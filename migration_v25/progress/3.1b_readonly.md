# Phase 3.1b: Readonly Sections (Feature 4)

## Status: COMPLETE

## Feature Summary
Inline `<span class="ql-readonly" contenteditable="false">` wrapping selected text.
Delete protection via text-change handler. Toolbar toggle button. Gray background styling.
**Also establishes the ERTE sanitizer foundation** used by all subsequent phases.

## Dependencies
- Phase 3.1a (Custom Slots) — toolbar button injection (**COMPLETE**)

## Key References
- USE_CASE_ANALYSIS.md Feature 4
- Spike Item 13 (setReadOnly observer works on extended component)
- Spike Item 19 (sanitizer strips `class` — need override strategy)
- V24 source: `blots.js` (ReadOnlyBlot), toolbar handler, text-change protection
- **Vaadin reference sources:** `/workspace/migration_v25/reference/` (see INDEX.md)

## Acceptance Criteria
- [x] ReadOnlyBlot registered (Inline, `<span class="ql-readonly" contenteditable="false">`)
- [x] Toolbar toggle button applies/removes readonly format
- [x] Delete protection: text-change handler reverts if readonly blot count decreases
- [x] Sanitizer whitelists `ql-readonly` class and `contenteditable="false"`
- [x] Cannot type/paste inside readonly sections
- [x] Lumo design tokens for styling (dark mode compatible)
- [x] `aria-readonly="true"` on blot for accessibility
- [x] Playwright tests pass (17/18 pass, 1 fixme — undo limitation)

## Test Results
- **17 passed, 1 skipped (fixme)** out of 18 readonly tests
- **43 passed, 6 skipped** across all existing ERTE tests (readonly + toolbar + shell)
- Zero regressions
- Fixme: "Readonly sections survive undo and redo" — known Quill limitation (undo removes readonly formatting)

---

## Plan

### Sanitizer Strategy: Hybrid (Client + Server)

**Problem:** `sanitize()` in RTE 2 is `static` package-private (`RichTextEditor.java:360`),
called from `private static` methods `presentationToModel()` / `modelToPresentation()` which
are passed as method references to `AbstractSinglePropertyField` constructor. These are
captured as `private final` lambdas — **cannot be overridden polymorphically**.

**Solution:**

| Direction | Strategy |
|-----------|----------|
| **Client → Server** | Delta is source of truth. `getValue()` HTML loses `ql-readonly` — **acceptable**, ERTE content read via `asDelta()`. |
| **Server → Client** | Override `setPresentationValue()` in `RteExtensionBase` → use `erteSanitize()` with ERTE whitelist instead of parent's `sanitize()`. |
| **Client-side HTML** | Override `__updateHtmlValue()` in JS subclass → preserve ERTE classes (`ql-readonly`, future: `ql-tab`, `ql-placeholder`) in `htmlValue` property. |

**`erteSanitize()`** is `protected static` in `RteExtensionBase`:
- Extends RTE 2 safelist with `span[class]`, `span[contenteditable]`
- Post-sanitization: only allows known ERTE classes (`ql-readonly`, etc.)
- Only allows `contenteditable="false"` (not other values)
- **Extensible:** each future phase adds its classes to `ALLOWED_ERTE_CLASSES`

**`setPresentationValue()` override** in `RteExtensionBase`:
- Applies `erteSanitize()` instead of parent's `sanitize()`
- Must replicate `pendingPresentationUpdate` debounce (parent field is `private`)
- Calls `dangerouslySetHtmlValue()` via `runBeforeClientResponse()`

### UI Design: Lumo Tokens

**Recommended CSS (replaces V24 hardcoded colors):**
```css
.ql-readonly {
  color: var(--lumo-secondary-text-color);
  background-color: var(--lumo-contrast-5pct);
  border-radius: var(--lumo-border-radius-s);
  padding-inline: 0.125em;
  outline: 1px solid var(--lumo-contrast-10pct);
  outline-offset: -1px;
}
```
- Works in both Lumo Light and Dark themes
- Subtle outline for better visual distinction
- Padding for breathing room

### JS Implementation

#### 1. ReadOnlyBlot (Quill 2 / Parchment 3)
```javascript
const Inline = Quill.import('blots/inline');
class ReadOnlyBlot extends Inline {
  static blotName = 'readonly';
  static className = 'ql-readonly';
  static create(value) {
    const node = super.create(value);
    if (value) {
      node.setAttribute('contenteditable', 'false');
      node.setAttribute('aria-readonly', 'true');
    }
    return node;
  }
  static formats(domNode) {
    return domNode.classList.contains('ql-readonly');
  }
}
Quill.register('formats/readonly', ReadOnlyBlot, true);
```
- Registered at module level (before element creation)
- `formats(domNode)` returns boolean (Quill 2 pattern)
- No `allowedChildren` needed (removed in Parchment 3)

#### 2. Delete Protection (`_initReadonlyProtection()`)
- text-change handler in `ready()` after `super.ready()`
- Checks `source === 'user'` AND `delta.ops.some(op => op.delete)`
- Compares readonly op count in `oldDelta` vs `_editor.getContents()`
- If count decreased: revert with `_editor.setContents(oldDelta, 'silent')`
- V24 pattern adapted for Quill 2 (same API)

#### 3. Toolbar Button (`_injectReadonlyButton()`)
- DOM injection in `ready()` (like `_injectToolbarSlots()`)
- `part="toolbar-button toolbar-button-readonly"` for test locator
- Lock icon via `vaadin-icon` with `icon="vaadin:lock"`
- Placed before format group in toolbar
- Click handler: `_onReadonlyClick()` toggles `readonly` format on selection
- Active state tracking via toolbar module's `update()` patch

#### 4. `__updateHtmlValue()` Override
- Preserves ERTE classes (`ql-readonly`, future additions) in `htmlValue`
- Uses regex to filter `class` attributes: keeps `ql-align-*`, `ql-indent-*`, and ERTE classes
- Delegates standard processing to parent's `__processQuillClasses()`

### Java Implementation

#### 5. `RteExtensionBase` — Sanitizer + `setPresentationValue`
```java
// New protected static method
protected static String erteSanitize(String html) { ... }

// Whitelist (extensible per phase)
private static final Set<String> ALLOWED_ERTE_CLASSES = Set.of("ql-readonly");

// Override server→client HTML path
@Override
protected void setPresentationValue(String newPresentationValue) { ... }
```

#### 6. `ErteReadonlyTestView.java` (NEW)
- Route: `erte-test/readonly`
- Editor (`id="test-editor"`) with initial content via `asDelta().setValue()`:
  - "Editable text before. " + readonly("This is readonly content.") + " Editable text after. "
  - "Another readonly section with " + readonly+bold("bold formatting") + "."
- `#toggle-readonly` button → `editor.setReadOnly(!editor.isReadOnly())`
- `#load-readonly` button → `asDelta().setValue(...)` with "Start " + readonly("Protected Section") + " End"
- `#delta-output` (Pre) updated via client-side text-change hook
- `#test-ready[data-ready="true"]` ready indicator (display:none)

### Files Changed

| File | Action | What |
|------|--------|------|
| `enhanced-rich-text-editor-v25/.../vcf-enhanced-rich-text-editor.js` | MODIFY | ReadOnlyBlot, protection, toolbar button, CSS, `__updateHtmlValue()` |
| `enhanced-rich-text-editor-v25/.../RteExtensionBase.java` | MODIFY | `erteSanitize()`, `setPresentationValue()` override |
| `enhanced-rich-text-editor-demo/.../ErteReadonlyTestView.java` | NEW | Test view for readonly tests |

`EnhancedRichTextEditor.java` — **no changes** in this phase.

### Implementation Order

1. ReadOnlyBlot registration (JS)
2. Readonly CSS with Lumo tokens (JS `static get styles()`)
3. `__updateHtmlValue()` override (JS, sanitizer client-side)
4. `_initReadonlyProtection()` text-change handler (JS)
5. `_onReadonlyClick()` toolbar handler (JS)
6. `_injectReadonlyButton()` DOM injection (JS)
7. `erteSanitize()` in `RteExtensionBase` (Java)
8. `setPresentationValue()` override in `RteExtensionBase` (Java)
9. `ErteReadonlyTestView.java` (Java, new file)
10. `v25-build.sh` + `v25-server-start.sh`
11. Run Playwright tests (18 in `readonly.spec.ts`)
12. Fix failures, iterate
13. Update progress file + STATUS.md + memory

### Risks

1. **`__updateHtmlValue()` is `@private`** — override is clean ES class inheritance but may break if Vaadin renames it in future versions. Acceptable: updatability rule means we adapt when it happens.
2. **`pendingPresentationUpdate` duplication** — overriding `setPresentationValue()` requires own debounce flag since parent's is `private`. Logic is simple (boolean + `runBeforeClientResponse`).
3. **`getSemanticHTML()` class output** — need to verify Quill 2 includes `className` in generated HTML for custom Inline blots. If not, `__updateHtmlValue()` override alone won't suffice.
4. **Whole-editor readonly** (tests 12-13) — standard RTE 2 `setReadOnly()`, should work without ERTE changes.
