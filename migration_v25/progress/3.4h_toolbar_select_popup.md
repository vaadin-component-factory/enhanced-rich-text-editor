# Phase 3.4h: ToolbarSelectPopup

**Status:** COMPLETE
**Type:** Feature Migration
**Priority:** MEDIUM — Helper class for custom toolbar extensions
**Created:** 2026-02-21
**Completed:** 2026-02-21

---

## Scope

Migrate `ToolbarSelectPopup` class from V24 to V25. This is a convenience wrapper around Vaadin's `ContextMenu` component that integrates with `ToolbarSwitch` for opening/closing.

---

## Background

### V24 Implementation

Location: `enhanced-rich-text-editor/src/main/java/com/vaadin/componentfactory/toolbar/ToolbarSelectPopup.java`

**Key Features:**
- Wraps Vaadin 24's `ContextMenu` component
- Opens/closes based on `ToolbarSwitch` active state
- Sets `openOnClick(true)`
- Syncs switch active state with context menu open state

**API:**
```java
// Constructor
ToolbarSelectPopup(ToolbarSwitch referencedSwitch)
```

**Usage Pattern:**
```java
ToolbarSwitch formatSwitch = new ToolbarSwitch();
ToolbarSelectPopup popup = new ToolbarSelectPopup(formatSwitch);
popup.addItem("Option 1", e -> { /* ... */ });
popup.addItem("Option 2", e -> { /* ... */ });
```

### V25 Changes

**Vaadin 25 ContextMenu API:**
- Verify `ContextMenu` API unchanged between V24 and V25
- Confirm `setOpenOnClick()`, `addOpenedChangeListener()` still exist
- Check if constructor signature changed

---

## Tasks

### 1. Create ToolbarSelectPopup.java (V25)

Location: `enhanced-rich-text-editor/src/main/java/com/vaadin/componentfactory/toolbar/ToolbarSelectPopup.java`

- [x] Copy V24 implementation as starting point
- [x] Update license header (2025)
- [x] Verify Vaadin 25 imports work (`com.vaadin.flow.component.contextmenu.ContextMenu`)
- [x] Test with simple example

### 2. Add JavaDoc

- [x] Class-level JavaDoc explaining purpose
- [x] Document integration with ToolbarSwitch
- [x] Add usage example in JavaDoc

### 3. Create Test View

- [x] Add test view showing context menu with toolbar switch
- [x] Test item selection
- [x] Test open/close state sync
- [x] Test dividers (Hr)
- [x] Test icons in menu items
- [x] Test multiple independent menus

### 4. Update Documentation

- [x] Add navigation entry in ErteTestLayout
- [ ] User documentation (deferred to Phase 3.5c)
- [ ] No upgrade guide entry needed (API 100% compatible)

---

## Testing Strategy

- **Manual:** Create simple demo with ToolbarSwitch + ToolbarSelectPopup, verify menu opens on click
- **Integration:** Verify with actual ERTE instance in demo app
- **Regression:** Compare behavior with V24 implementation

---

## Dependencies

- ✅ Phase 3.1a (Toolbar Slot System) — provides `ToolbarSwitch`
- ⚠️ Phase 3.4f (Slotted Styles) — may be needed for proper button appearance

---

## Definition of Done

- [x] `ToolbarSelectPopup.java` created with V25-compatible implementation
- [x] JavaDoc complete
- [x] Manual testing shows context menu works correctly
- [x] Open/close state syncs with switch
- [x] Progress file updated to COMPLETE
- [x] Commit created: "Add ToolbarSelectPopup helper class (Phase 3.4h)"

---

## Implementation Notes

### V25 Changes: NONE

**Key finding:** ToolbarSelectPopup implementation is **100% identical** between V24 and V25 (except license header year).

**Why no changes needed:**
- `ContextMenu` API unchanged between V24 and V25
- `setOpenOnClick(boolean)` — same API
- `addOpenedChangeListener(ComponentEventListener)` — same API
- State sync pattern (`event.isOpened()` → `switch.setActive()`) — works identically

**Comparison with ToolbarPopover (Phase 3.4g):**
- ToolbarPopover required removing V24 workarounds (`restoreFocusOnClose`, manual attach/detach listeners)
- ToolbarSelectPopup had **zero V24 workarounds** — clean implementation from the start
- ContextMenu is more stable/mature than Popover component

### V25 ContextMenu API

**Constructor:**
```java
super(referencedSwitch) // ContextMenu(Component target)
```

**Configuration:**
```java
setOpenOnClick(true) // Opens on left-click (default is right-click)
```

**State Sync:**
```java
addOpenedChangeListener(event -> referencedSwitch.setActive(event.isOpened()))
```

**Menu Items:**
- `addItem(String text, listener)` — simple text item
- `addItem(Component component, listener)` — custom component (e.g., HorizontalLayout with Icon + Span)
- `addComponent(Component...)` — non-clickable components (dividers, etc.)

**Note:** There is NO `addItem(Icon, String, listener)` convenience method in V25. For icon + text items, create a layout:
```java
HorizontalLayout iconText = new HorizontalLayout(icon, new Span(text));
menu.addItem(iconText, listener);
```

### Tables Addon Compatibility

**Usage in Tables addon (V24):**
```java
// enhanced-rich-text-editor-tables/src/main/java/com/vaadin/componentfactory/EnhancedRichTextEditorTable.java:182
ToolbarSwitch modifyTableSwitch = new ToolbarSwitch(VaadinIcon.PENCIL);
ToolbarSelectPopup modifyTableMenu = new ToolbarSelectPopup(modifyTableSwitch);
modifyTableMenu.addItem("Add Row Above", e -> ...);
modifyTableMenu.addItem("Add Row Below", e -> ...);
// etc.
```

**Migration effort for Phase 4:** **ZERO**. Tables addon code will work as-is with the V25 implementation.
